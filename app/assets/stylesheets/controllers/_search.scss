// app/assets/stylesheets/controllers/_search.scss

@use 'sass:map';
@use 'sass:math';

@use 'shared/variables'         as *;
@use 'shared/functions'         as *;
@use 'shared/mixins'            as *;
@use 'shared/controls/grids'    as grid;
@use 'shared/feature/model'     as model;

@use 'layouts/controls/buttons' as button-classes;
@use 'feature/model'            as model-classes;

//=============================================================================
// Unified Search pages
//=============================================================================

$row-separation:        0.75rem;
$row-separation-narrow: 1rem;
$row-line-height:       1.5;

$value-right-margin:    calc(2 * #{$flex-gap-x});

// The "top" values for sticky positioning -- the "narrow" version is much
// larger because it is actually applied only to the .field-Title element,
// which needs to stick lower in order to keep from scrolling over the already-
// stuck item number.  Also, this isn't using "vh" units because this seemed to
// be inconsistent between emulations of, e.g., iPhone 5 and Galaxy Note 9.

$sticky-top-wide:   2vh;
$sticky-top-medium: 1.5vh;
$sticky-top-narrow: 3.125rem;

//=============================================================================
// Internal mixins
//=============================================================================

@mixin search-item-columns($label: 0.25fr, $value: 1fr) {
    grid-template-columns: [label] minmax(auto, $label) [value] $value;
}

//=============================================================================
// Internal placeholder classes
//=============================================================================

// Use to display text as a substitute for a logo.
%text-logo {
    padding:       1px 0.5rem;
    font-size:     medium;
    font-weight:   normal;
    color:         $root-rev-fg-color;
    background:    $panel-accent;
    border:        1px solid transparent;
    border-radius: 0.5rem;
}

//=============================================================================
// Base definitions
//=============================================================================

// @see LogoHelper#repository_source_logo
.repository {

    &.name {

        display:         flex;
        flex-direction:  column;
        justify-content: center;

        div {
            @extend %text-logo;
        }
    }

    img {

        height:     3rem;
        max-height: 3rem;
        max-width:  100%;
        background: white;

        @media #{$wide-screen} {
            height:     4.5rem;
            max-height: 4.5rem;
        }
    }
}

// Label/value pairs appropriate for either .search-list-item or .file-info.
.search-label-value-pairs {

    // noinspection SassScssResolvedByNameOnly
    @extend %label-value-pairs;

    @include grid.row-gap($row-separation);

    @media #{$narrow-screen} {
        @include grid.row-gap($row-separation-narrow);
    }

    //=========================================================================
    // Components
    //=========================================================================

    .label,
    .value {
        margin-bottom: 0;
    }

    .label {

        line-height: $row-line-height;

        @media #{$narrow-screen} {
            margin-bottom: -0.75rem;
        }

        &.field-Title {
            margin: 0.67rem 0 auto;
        }
    }

    .value {

        &.textbox {
            box-shadow: 0 0 0 0.25rem $root-bg-color, 0 0 0 0.375rem lightgray;
        }

        &.array {

            @include grid.row-gap($row-separation);

            display:       grid;
            align-items:   center;
            align-content: center;

            @media #{$wide-screen} {
                grid-template-columns: repeat(6, minmax(16.67%, 0.1667fr));
            }

            @media #{$medium-width} {
                grid-template-columns: repeat(3, minmax(33%, 1fr));
            }

            @media #{$narrow-screen} {
                margin-left:           0;
                grid-template-columns: 1fr;
            }

            // Array element properties
            $element-border:    1px;
            $element-x-padding: 5px;
            $element-y-padding: 1px;
            $element-x-margin:  -$element-x-padding - $element-border;
            $element-y-margin:  -$element-y-padding - $element-border;

            > * {

                @include control-shadow;

                display:             block;
                height:              100%;
                padding:             $element-y-padding $element-x-padding;
                background:          ghostwhite;
                border:              $element-border solid gray;
                border-right-color:  black;
                border-bottom-color: black;
                border-radius:       math.div($element-x-padding, 2);
                cursor:              text;

                // noinspection CssReplaceWithShorthandSafely
                @media #{$not-narrow-screen} {
                    margin:          $element-y-margin $element-x-margin;
                    margin-right:    1rem;
                }

                @media #{$wide-screen} {
                    word-break:      keep-all;
                    word-wrap:       break-word;
                }

                @media #{$narrow-screen} {
                    margin:          $element-y-margin 0;
                }
            }
        }

        &.field-Title {

            display:         flex;
            flex-direction:  row;
            justify-content: space-between;
            gap:             $flex-gap-y $flex-gap-x;
            margin:          0 0 auto;
            font-size:       x-large;
            font-weight:     bold;

            @media #{$narrow-screen} {

                @include grid.column-span;

                flex-wrap: wrap-reverse;
            }

            a:not(:hover) {
                text-decoration: none;
            }

            // @see SearchHelper#title_and_source
            .title {
                flex:   0.33 1 auto;
                margin: 0.5rem 0 auto;
            }

            // @see SearchHelper#title_and_source_logo
            .repository {

                flex: 0 0 auto;

                img {
                    max-height: 3rem;
                }
            }
        }
    }
}

// File format information section.
.file-info {

    @extend .model-list-item;
    @extend .search-label-value-pairs;

    display:    grid;
    margin-top: 1rem;

    grid-template-columns: max-content 1fr;
    gap:                   1rem;

    @media #{$not-wide-screen} {
        grid-template-columns: 1fr;
    }

    //=========================================================================
    // Components
    //=========================================================================

    .label {

        grid-column-start: 1;

        &.logo {

            @include invisible;

            @media #{$not-wide-screen} {
                display: none;
            }
        }

        &.field-Title {
            max-width: unset;
            font-size: unset;
        }
    }

    .value {

        &.logo {
            img {
                max-height: 7rem;
                border:     1px solid lightgray;
            }
        }

        &.array {

            max-width: unset;

            @media #{$medium-width} {
                grid-template-columns: minmax(max-content, 50%);
            }

            > * {

                word-break: normal;

                @media #{$medium-width} {
                    margin-left: 0;
                }
            }
        }

        ul {

            margin:     0;
            padding:    0;
            list-style: square;
            list-style: disclosure-closed; // NOTE: Firefox only

            @media #{$not-wide-screen} {
                list-style-position: inside;
            }
        }
    }
}

//=============================================================================
// Metadata record search index page
//=============================================================================

/**
 * During transitional times, the index may be supplying the same metadata
 * field via two (or more) field names, this mixin supports "turning off"
 * label/value pairs of an older field if a label/value pair of the newer
 * field is present.
 *
 * For the mixin to operate, ordering of pairs in "en.emma.search.record"
 * must be maintained so that older name(s) for a given field follow the
 * newest name for the field.
 */
@mixin prioritize($new-name, $old-name) {
    .value.field-#{$new-name} + .label.field-#{$old-name} {
        &, & + * { display: none; }
    }
    .pair.field-#{$new-name} + .pair.field-#{$old-name} {
        &, & + * { display: none; }
    }
}

// Metadata record label/value pairs for index listings.
.search-list-item {

    @extend .model-list-item;
    @extend .search-label-value-pairs;

    // If this item is *false* then the label for the title field is displayed
    // like other metadata labels.  If it is *true* then the label is not
    // visible and the title expands across all columns.

    $title-spans-entry: true;

    $textbox-vspace: 0.25rem;

    $narrow-indent:  0.375rem;

    //=========================================================================
    // Components
    //=========================================================================

    > .label,
    > .pair > .label {

        &.text,
        &.date,
        &.url {
            display:        flex;
            flex-direction: row;
            align-items:    center;
            height:         100%;
        }

        &.textbox {
            margin-top: $textbox-vspace;
        }

        &.field-Title {

            @if $title-spans-entry {

                @include sr-only;

                position:       unset !important;

            } @else {

                position:	    sticky;
                top:		    2vh;
                z-index:        $z-raised;
                display:	    flex;
                flex-direction: row;
                align-items:	flex-start;
                margin:		    0;
                padding-top:    1.25rem;
                background:	    $root-bg-color;
                box-shadow:
                    0.5rem  -0.5rem  0       0.5rem $root-bg-color,
                    0.25rem -0.25rem 0.75rem 0.5rem $root-bg-color;
            }
        }

        // Field labels with help icons:
        &.field-RetrievalLink {
            display:        flex;
            flex-direction: row;
            align-items:    center;
        }

        // Field labels with help icons that are only for the submission form:
        &.field-Repository {
            .help-popup {
                display: none;
            }
        }

        .text {
            @media #{$medium-width} {
                line-height:    1.25;
                letter-spacing: -0.5px;
            }
        }

        .help-popup .control.icon {
            margin-left: 0.375rem;
            padding:     0.25rem 0.3125rem;
            font-size:   small;
        }
    }

    > .value,
    > .pair > .value {

        height:      100%;
        line-height: $row-line-height;

        &.text,
        &.date,
        &.url {

            display:         flex;
            flex-direction:  column;
            justify-content: center;

            @media #{$narrow-screen} {
                padding-left: $narrow-indent;
            }

            // If conditions cause the URL to wrap, keep the lines together.
            a {
                line-height: 1.25;
                word-break:  break-all;

                @media #{$narrow-screen} {
                    height: 100%;
                }
            }
        }

        &.list,
        &.textbox {

            width:       max-content;
            min-width:   15vw;
            max-height:  20vh;
            overflow-y:  auto;

            @media #{$wide-screen} {
                max-width: 75vw;
            }

            @media #{$medium-width} {
                max-width: 62.5vw;
            }

            @media #{$narrow-screen} {
                width:     auto;
                max-width: calc(100vw - 2.5rem);
            }
        }

        &.list {
            // Firefox handling of max-content sometimes allows the longest
            // lines to wrap.  This makes the wrapping more evident by showing
            // that portion indented.
            > * {

                $indent: 1rem;

                margin-left: $indent;
                text-indent: -$indent;

                @media #{$narrow-screen} {
                    padding-left: $narrow-indent;
                }
            }
        }

        &.textbox {

            margin-top:    $textbox-vspace;
            margin-bottom: $textbox-vspace;
            height:        calc(100% - #{2 * $textbox-vspace});
            line-height:   1.25;

            @media #{$narrow-screen} {
                margin-left:  $flex-gap-x;
                padding-left: calc(#{$narrow-indent} - #{$flex-gap-x});
            }
        }

        &.field-Title {

            position:      sticky;
            z-index:       $z-raised;
            align-items:   flex-start;
            margin:        0;
            height:        unset;
            line-height:   unset;
            font-size:     x-large;
            font-weight:   bold;
            background:	   $root-bg-color;
            border-bottom: 1px solid darkgray;

            @if $title-spans-entry {
                @include grid.column-span;
            }

            @media #{$wide-screen} {
                top:        $sticky-top-wide;
                box-shadow:
                     0.50rem -2.00rem  1.00rem  2.00rem  $root-bg-color,
                     0        0        0.25rem  0.50rem  $root-bg-color;
            }

            @media #{$medium-width} {
                top:        $sticky-top-medium;
                column-gap: calc(3 * #{$flex-gap-x});
                box-shadow:
                     0       -1.00rem  0        0.50rem  $root-bg-color,
                     0        0        0.25rem  0.25rem  $root-bg-color;
            }

            @media #{$narrow-screen} {

                @include hyphenation;

                top:            $sticky-top-narrow;
                padding-bottom: 0.5rem;
                border-color:   $root-fg-color;
                box-shadow:
                     0       -0.50rem  0        0.25rem  $root-bg-color,
                     0        0.25rem  0.25rem  0        $root-bg-color;
            }

            // @see SearchHelper#title_and_source
            .title {

                margin: 0;
                flex:   1 1 100%;

                @media #{$wide-screen} {
                    height:         100%;
                    padding-bottom: 1rem;
                    font-size:      larger;
                }

                @media #{$medium-width} {
                    height:         100%;
                    padding-bottom: 0.75rem;
                    margin-right:   $value-right-margin;
                }

                /**
                 * NOTE: Height is limited to avoid edge-case titles taking up
                 *  a large portion of the screen -- using "em" units in order
                 *  to relate to the element's own font.
                 *
                 * Most titles can be shown in 3 lines or less; a little extra
                 * height is given so that if the title needs to be scrolled,
                 * the fourth line is partially displayed but clipped.
                 */
                @media #{$narrow-screen} {
                    max-height:     4em;
                    margin-top:     0.5rem;
                    padding-right:  $scroll-easement;
                    overflow-y:     auto;
                }
            }

            // @see SearchHelper#title_and_source_logo
            .repository {

                display:         flex;
                justify-content: flex-end;

                @media #{$wide-screen} {
                    padding-bottom:  1rem;
                }

                @media #{$medium-width} {
                    margin-left:     $value-right-margin;
                    padding-bottom:  0.75rem;
                }

                @media #{$narrow-screen} {
                    justify-content: flex-start;
                    margin-top:      -0.5rem;
                }

                img {

                    height:     auto;
                    padding:    0.5rem 0.75rem;
                    border:     1px solid lightgray;
                    box-shadow: 2px 2px 6px 0 lightgray;

                    @media #{$not-wide-screen} {
                        max-height: 2.5rem;
                    }
                }
            }

            // Controls for moving up and down through the list.
            // @see SearchHelper#prev_next_controls
            .prev-next {

                display:        flex;
                flex-direction: column;
                align-items:    center;
                margin:         0;
                flex:           0 0 auto;

                @media #{$wide-screen} {
                    margin-left:    $flex-gap-x;
                    padding-top:    0.75rem;
                }

                @media #{$medium-width} {
                    margin-left:    $flex-gap-x;
                    padding-top:    0.5rem;
                }

                @media #{$narrow-screen} {
                    flex-direction: row;
                    margin-top:     -0.5rem;
                    margin-bottom:  auto;
                    line-height:    1.5;
                }

                .prev,
                .next {

                    @include hover-highlight;

                    min-width:     unset;
                    margin:        0;
                    border-radius: 50%;

                    &:focus {
                        text-decoration: none;
                        outline-offset:  0;
                    }

                    &:hover {
                        text-decoration: none;
                    }

                    &.forbidden {

                        color:  blue;
                        cursor: default;

                        &:focus {
                            @include focus;
                        }
                    }

                    .symbol {

                        display:    block;
                        width:      1.25em; // em not rem
                        text-align: center;

                        @media #{$narrow-screen} {
                            width:  1.5em; // em not rem
                        }
                    }
                }

                .prev {
                    @media #{$not-narrow-screen} {
                        margin-top: -0.5rem;
                    }
                }

                .next {
                    @media #{$not-narrow-screen} {
                        margin-top: 0.25rem;
                    }
                    @media #{$narrow-screen} {
                        margin-left: 0.25rem;
                    }
                }
            }
        }

        &.field-Format {
            font-weight: bold;
        }

        &.field-Identifier {
            font-weight: bold;
        }

        &.field-Subject {
            padding-right: 0.5rem;
        }

        &.field-RetrievalLink {
            @media #{$narrow-screen} {
                margin-bottom: 1rem;
            }
        }
    }

    //=========================================================================
    // Other
    //=========================================================================

    .invalid {
        color:  $error-fg;
        cursor: help;
    }

    // File format information section label.
    .file-info-label {
        display:       block;
        margin-top:    1.5rem;
        margin-left:   0.75rem;
        margin-bottom: -0.5rem;
        font-weight:   bold;
    }

    // File format information section.
    .file-info {
        padding:       0.75rem;
        border:        2px solid gray;
        border-radius: 1rem;
        box-shadow:    inset 0 0 0.75rem -0.25rem gray;
    }

    //=========================================================================
    // Hide neighboring field pairs with the same meaning.
    //=========================================================================

    @include prioritize(Version,              Version);         // NOTE [1]
    @include prioritize(DateCopyright,        PublicationDate); // NOTE [2]
    @include prioritize(RepositoryUpdateDate, RepositoryMetadataUpdateDate);
    @include prioritize(RemediationDate,      LastRemediationDate);
    @include prioritize(Comments,             RemediationComments);
    @include prioritize(Comments,             LastRemediationNote);
    @include prioritize(RemediationComments,  LastRemediationNote);
    @include prioritize(RemediatedAspects,    Remediation);
    @include prioritize(TextQuality,          Quality);

    // NOTE [1] Prioritize 'emma_version' over 'bib_version'.
    // NOTE [2] If both are present then 'emma_PublicationDate' will just be
    //  derived from 'dcterms_dateCopyright', so the former is redundant.
}

// Zero or more .search-list-item elements.
.search-list {

    @extend .model-list;

    @media #{$narrow-screen} {
        grid-template-columns: 1fr;
    }

    //=========================================================================
    // Components
    //=========================================================================

    $item-number-bg:     lighter($uva-accent-blue, 97.5%);
    $item-number-border: $uva-accent-blue;

    .pagination-top {
        // TODO: ???
    }

    .number {

        margin-top:  0;
        font-size:   large;
        font-weight: bold;

        @media #{$not-narrow-screen} {
            margin-bottom:  calc(2 * #{model.$list-item-gap-y});
            padding-left:   0.25rem;
            padding-right:  0.5rem;
            text-align:     right;
            background:     $item-number-bg;
            border:         1px solid $item-number-border;
        }

        @media #{$wide-screen} {
            padding-bottom: 1.75rem;
        }

        @media #{$medium-width} {
            margin-top:     calc(2 * #{model.$list-item-gap-y});
            padding-bottom: calc(2 * #{model.$list-item-gap-y});
        }

        @media #{$narrow-screen} {

            @include grid.column-span;

            position:       sticky;
            top:            0;
            margin-bottom:  0;
            padding:        0;
            text-align:     center;
            background:     $root-bg-color;
            box-shadow:     0 0 0 0.75rem $root-bg-color;
        }

        .container {

            @media #{$wide-screen} {
                top:            $sticky-top-wide;
                margin-top:     0.625rem;
            }

            @media #{$medium-width} {
                top:            $sticky-top-medium;
                margin-top:     0.75rem;
            }

            @media #{$narrow-screen} {
                top:            0;
                flex-direction: row;
            }

            .value {

                margin: 0;

                @media #{$wide-screen} {
                    padding-top:   0.25rem;
                }

                @media #{$medium-width} {
                    padding-top:   0.125rem;
                }

                @media #{$narrow-screen} {
                    height:        1.75rem;
                    padding-top:   0.125rem;
                    margin-bottom: $gap-y;
                    background:    $item-number-bg;
                    border-bottom: 1px solid $item-number-border;
                    flex:          1 0 auto;
                }
            }

            .icon-tray {

                $icon-pad:      (model.$icon-pad);
                $icon-pad-half: math.div($icon-pad, 2);

                @media #{$not-narrow-screen} {
                    margin-top:     1rem;
                    margin-left:    0;
                    margin-right:   -$icon-pad;
                    padding-top:    $icon-pad-half;
                    padding-bottom: $icon-pad-half;
                    box-shadow:     2px 2px 1px 1px lightgray;
                }

                @media #{$narrow-screen} {
                    position:       absolute;
                    top:            0.125rem;
                    right:          0;
                    flex-direction: row;
                    margin:         0;
                    padding:        0 $icon-pad-half;
                }
            }

            .icon {
                @media #{$narrow-screen} {

                    margin: 0;

                    & + .icon {
                        margin-left: 0.25rem;
                    }
                }
            }
        }
    }

    /**
     * NOTE: This is tuned to account for the varying types of fields across
     *  the records displayed in search.  Without some adjustment, the grid of
     *  each record aligns only to the widest label that it happens to be
     *  displaying.
     */
    .search-list-item {

        @media #{$not-narrow-screen} {
            margin-bottom:         calc(2 * #{model.$list-item-gap-y});
            padding-bottom:        0.5rem;
        }

        @media #{$wide-screen} {
            @include search-item-columns(0.1375fr);
        }

        @media #{$medium-width} {
            margin-top:            calc(2 * #{model.$list-item-gap-y});
            @include search-item-columns(0.25fr);
        }

        @media #{$narrow-screen} {
            @include grid.column-span;
        }

        // Superfluous because ModelHelper::Fields#field_pairs folds the
        // information from :rem_complete into :rem_coverage.
        .field-Complete {
            display: none;
        }
    }
}

//=============================================================================
// Metadata record show page
//=============================================================================

// Metadata record values.
.search-details {
    @extend .model-details;
}

// Container for a .search-details.
.search-container {

    @extend .model-container;

    //=========================================================================
    // Sections
    //=========================================================================

    .search-details {}
}

//=============================================================================
// New styles
//=============================================================================

@mixin primary($bg) {
    background-color: $bg;
}

@mixin secondary($fg) {

    $gap:    2px;
    $box:    2px + $gap;
    $mask:   white;
    $shift:  5px;
    $exdent: 0.25rem;

    box-shadow:
             0 0 0 $gap $mask, // inner gap
             0 0 0 $box $fg;   // outer boundary

    @media #{$not-narrow-screen} {

        &.value.array {
            box-shadow:
                0 0 0 $gap $mask, // inner gap
                -$gap 0 0 $gap $mask, // mask left side inner boundary
                0 0 0 $box $fg,   // inner boundary
                -$shift 0 0 $gap $mask, // outer gap
                -$shift 0 0 $box $fg;   // outer boundary
        }

        &.value:not(.array) {
            margin-left:   -$exdent;
            padding-left:  $exdent;
            padding-right: 2 * $exdent;
        }
    }

    @media #{$narrow-screen} {

        &.value:not(.array) {
            margin-left:   0;
            padding-right: 3 * $exdent;
        }

        &.value:not(.array):not(.list) {
            padding-left:  $exdent;
        }

    }
}

@mixin type-marker($term, $color: red, $inner-color: black) {
    &:before {
        content:        '[#{$term}]';
        position:       absolute;
        left:           -2rem;
        padding:        0 0.25rem;
        color:          white;
        background:     $color;
        font-weight:    bold;
        text-transform: uppercase;
        text-shadow:
                        -1px -1px 0 $inner-color,
                        -1px  1px 0 $inner-color,
                        1px -1px 0 $inner-color,
                        1px  1px 0 $inner-color;
    }
}

$score-fields-bg: lightgray;

@mixin score-fields {
    &.field-CreatorScore,
    &.field-IdentifierScore,
    &.field-KeywordScore,
    &.field-PubDate,
    &.field-PublisherScore,
    &.field-RemDate,
    &.field-SortDate,
    &.field-TitleScore {
        font-weight: bold;
        background:  $score-fields-bg;
        @content;
    }
}

// Additional class along with "search-index", "search", and "index".
body.new-style,
body.dev-style,
body.search-v2,
body.search-v3,
body.grid-style,
body.compact-style,
body.aggregate-style {

    $narrow-left-pad:        0.25rem;
    $narrow-logo-height:     2rem;
    $narrow-item-separation: 1.5rem;

    $wide-open-pad:          1rem;
    $medium-open-pad:        0.875rem;
    $narrow-open-pad:        0.75rem;

    $v-shift:                0.25rem;
    $v-shift-half:           math.div($v-shift, 2);
    $h-shift:                0.125rem;

    // Box shadow sections which prevent scrolled text from
    // appearing above the title.
    $title-scroll-mask:
        0.25rem  -0.25rem  0         0.5rem  $root-bg-color,
        0.125rem  0        0.125rem  0.5rem  $root-bg-color;

    //=========================================================================
    // Sections
    //=========================================================================

    /**
     * In order to have the page title, pagination controls, and data analysis
     * controls together, h1.heading and div.pagination-top are moved inside of
     * this element which is created dynamically in search.js.
     */
    .heading-bar {

        display: grid;

        @media #{$not-narrow-screen} {
            grid-template-columns: auto 1fr;
        }

        @media #{$medium-width} {
            margin:  calc(2 * #{model.$list-item-gap-y}) auto;
            row-gap: 1rem;
        }

        @media #{$narrow-screen} {
            grid-template-columns: 1fr;
        }

        //=====================================================================
        // Components
        //=====================================================================

        .heading {
            @media #{$medium-width} {
                margin:      auto 0;
                grid-row:    1;
                grid-column: 1;
            }
        }

        // Moved from top of .search-list
        .pagination-top {

            margin:         auto 0;
            flex-direction: row-reverse;
            column-gap:     1rem;
            row-gap:        0.5rem;
            grid-column:    unset;

            @media #{$medium-width} {
                grid-row: 1/3;
                row-gap:  1rem;
            }

            @media #{$narrow-screen} {
                row-gap:         0.25rem;
                justify-content: center;
            }

            .counts {

                flex-direction: row-reverse;
                column-gap:     1rem;

                @media #{$medium-width} {
                    flex-basis: 100%;
                }

                @media #{$narrow-screen} {
                    margin:          0.5rem 0;
                    flex-direction:  row;
                    column-gap:      0.5rem;
                    justify-content: center;
                    align-items:     baseline;
                    flex:            1 1 auto;
                }
            }

            // Button tray enabled for the desktop and handheld form factors.
            .button-tray {

                display:         flex;
                flex-direction:  row-reverse;
                flex-wrap:       wrap-reverse;
                column-gap:      1rem;
                row-gap:         0.5rem;

                @media #{$narrow-screen} {
                    margin-top:      0.5rem;
                    column-gap:      0.5rem;
                    row-gap:         0.25rem;
                    justify-content: center;
                }

                @media #{$medium-width} {
                    display: none;
                }
            }
        }

        // Button tray enabled for the tablet form factor.
        .button-tray {

            display: none;

            @media #{$medium-width} {
                display:         flex;
                flex-direction:  row-reverse;
                column-gap:      1rem;
                row-gap:         0.5rem;
                justify-content: flex-end;
                grid-row:        2;
                grid-column:     1;
            }
        }
    }

    .search-list {

        column-gap: 1%;

        @media #{$narrow-screen} {
            margin:     calc(2 * #{model.$list-item-gap-y}) 0;
            column-gap: 0.5rem;
        }

        //=====================================================================
        // Components
        //=====================================================================

        $narrow-title-shadow: 0 0 0.5rem 0.25rem ghostwhite;

        .toggle {

            width:           1.65rem;
            height:          1.5rem;
            padding:         0;
            line-height:     0;
            text-decoration: none;
            border-radius:   50%;
            border-color:    darkgray;

            @media #{$narrow-screen} {
                width:       1.875rem;
                height:      1.75rem;
            }

            /**
             * This may just be a Firefox thing, but the right triangle icon
             * seems shifted with respect to the down triangle icon.
             */
            &:not(.open) {
                text-indent: 2px;
            }

            &:hover {
                box-shadow: none;
            }

            &.for-item {
                // NOTE: open/close at the title level
            }

            &.for-part {
                // NOTE: open/close a bibliographic part under a title
            }

            &.for-format {
                // NOTE: open/close a format within a part section
            }

            &.for-file {
                // NOTE: open/close a file within a format sub-section

            }
        }

        .number {

            position:   relative;
            margin:     auto 0;
            padding:    0;
            border:     none;
            box-shadow: none;
            background: none;

            @media #{$wide-screen} {
                padding-top:     0.5rem;
            }

            @media #{$medium-width} {
                margin-right:    0.375rem;
                padding-top:     0.5rem;
                padding-bottom:  0.5rem;
            }

            @media #{$narrow-screen} {
                margin-top:      0;
                padding-top:     0.5rem;
                grid-column-end: 1;
                z-index:         $z-controls;
            }

            //=================================================================
            // Special handling for the item toggle.
            //=================================================================

            .container {

                height: 3rem;

                @media #{$not-narrow-screen} {
                    display: none;
                }

                .value {
                    @include sr-only;
                }

                .toggle.for-item {
                    align-self:    flex-end;
                    margin-bottom: 0;
                }
            }

            > .toggle.for-item {

                margin-top: 0.125rem;

                @media #{$narrow-screen} {
                    display: none;
                }
            }

            //=================================================================
            // When the associated list item is open.
            //=================================================================

            &.open {

                @media #{$wide-screen} {
                    $excess:     3.5rem;
                    height:      calc(100% - #{$excess});
                    margin-top:  1.75rem;
                    padding-top: 0.125rem;
                }

                @media #{$medium-width} {
                    $excess:     2.5rem;
                    height:      calc(100% - #{$excess});
                    margin-top:  1.375rem;
                    padding-top: 0.3125rem;
                }

                @media #{$narrow-screen} {
                    $excess:     $narrow-logo-height + $narrow-item-separation;
                    height:      calc(100% - #{$excess});
                    /**
                     * Constrain the width so that the higher z-index .number
                     * doesn't prevent sub-section toggles from being clicked.
                     * The "overflow: visible" *shouldn't* be needed -- it's
                     * the specifying of the width for .container that should
                     * keep the item toggle from being clipped/deformed.
                     */
                    width:       0;
                    overflow:    visible;
                }

                .container {
                    width: min-content;
                }

                .toggle.for-item {
                    position: sticky;
                    top:      3vh;
                }
            }
        }

        // Item "closed" by default; click to toggle "open".
        .search-list-item {

            min-width: 100%;
            margin:    0;

            @media #{$narrow-screen} {
                width:             92.5vw;
                margin-left:       -(2rem + $narrow-left-pad);
                margin-right:      (2rem + $narrow-left-pad);
                margin-bottom:     $narrow-item-separation;
                grid-column-start: 2;
            }

            > .value,
            > .pair > .value {

                &.field-Title {

                    max-width:  100%;
                    align-self: baseline;

                    @media #{$not-narrow-screen} {
                        border: none;
                    }

                    @media #{$narrow-screen} {
                        justify-content: flex-end;
                        background:      ghostwhite;
                    }

                    > * {
                        margin:     auto 0;
                        padding:    0;
                        align-self: center;
                    }

                    .title {

                        letter-spacing: -0.125px; // NOTE: needed for Firefox
                        cursor:         default;

                        @media #{$wide-screen} {
                            flex-basis:    100%;
                            border-top:    $wide-open-pad solid transparent;
                            border-bottom: $wide-open-pad solid transparent;
                        }

                        @media #{$medium-width} {
                            flex-basis:    100%;
                            border-top:    $medium-open-pad solid transparent;
                            border-bottom: $medium-open-pad solid transparent;
                        }
                    }

                    .repository {

                        img {

                            box-shadow: 2px 2px 4px 0 lightgray;

                            @media #{$narrow-screen} {
                                max-height: $narrow-logo-height;
                            }
                        }
                    }

                    .prev-next {
                        display: none;
                    }
                }
            }
        }

        //=====================================================================
        // Components - when the list item is open
        //=====================================================================

        .search-list-item.open {

            > .value,
            > .pair > .value {

                &.field-Title {

                    top: 1vh;

                    @media #{$not-narrow-screen} {
                        box-shadow: $title-scroll-mask;
                    }

                    @media #{$narrow-screen} {
                        box-shadow: $narrow-title-shadow, $title-scroll-mask;
                    }

                    > * {
                        @media #{$not-narrow-screen} {
                            align-self: flex-start;
                        }
                    }

                    .title {
                        @media #{$not-narrow-screen} {
                            box-shadow:
                                1px -1px  0  1px  $root-bg-color,
                                1px  1px  0  1px  darkgray;
                        }
                    }

                    .repository {
                        @media #{$not-narrow-screen} {
                            margin-top: 0;
                        }
                        @media #{$narrow-screen} {
                            position:   sticky;
                            top:        0;
                        }
                    }
                }
            }
        }

        //=====================================================================
        // Components - when the list item is closed
        //=====================================================================

        .search-list-item:not(.open) {

            @media #{$not-narrow-screen} {
                max-height:     4rem;
                padding-bottom: 1rem;
            }

            > .value,
            > .pair > .value {

                &.field-Title {

                    @media #{$not-narrow-screen} {
                        box-shadow: none;
                    }

                    @media #{$narrow-screen} {
                        box-shadow: $narrow-title-shadow;
                    }

                    .title {
                        overflow:      hidden;
                        white-space:   nowrap;
                        text-overflow: ellipsis;
                    }
                }
            }

            > :not(.row-1) {
                display: none !important;
            }
        }
    }

    //=========================================================================
    // Sections - title colorization
    //=========================================================================

    .restore-button,
    .colorize-button,
    .field-highlight-button {

        @extend .basic-button;

        &.active {
            background-color: $input-disabled-bg;
            border-color:     $input-disabled-fg;
        }
    }

    .search-list {

        //=====================================================================
        // Components
        //=====================================================================

        .search-list-item.colorized {

            > .value,
            > .pair > .value {

                &.field-Title {

                    border: none;

                    @media #{$not-narrow-screen} {
                        margin-left:  -0.25rem;
                        padding-left: 0.25rem;
                    }

                    @media #{$narrow-screen} {
                        margin-left: -$narrow-left-pad;
                        .title {
                            margin-left: $narrow-left-pad;
                        }
                    }

                    .identity-number {

                        word-break: keep-all;
                        flex:       1 0 auto;

                        @media #{$wide-screen} {
                            margin-top:   $wide-open-pad;
                            font-size:    larger;
                        }

                        @media #{$medium-width} {
                            margin-top:   $medium-open-pad;
                        }

                        @media #{$narrow-screen} {
                            margin-top:   $narrow-open-pad;
                            margin-right: $narrow-open-pad;
                            flex:         0 1 auto;
                        }

                        // Highlight out-of-sequence title index numbers.
                        &.error,
                        &.exile {

                            $fg-color: red;
                            $bg-color: white;

                            @media #{$wide-screen} {
                                margin-top:   $wide-open-pad   - $v-shift-half;
                            }
                            @media #{$medium-width} {
                                margin-top:   $medium-open-pad - $v-shift-half;
                            }
                            @media #{$narrow-screen} {
                                margin-top:   $narrow-open-pad - $v-shift-half;
                                margin-right: $narrow-open-pad - $v-shift-half;
                            }

                            margin-right:  -$h-shift;
                            color:         $fg-color;
                            background:    $bg-color;
                            border-bottom: $v-shift solid $bg-color;
                            border-left:   $h-shift solid $bg-color;
                            border-right:  $h-shift solid $bg-color;
                            border-radius: 0.375rem;
                            box-shadow:    0 0 0 0.25rem $fg-color;
                        }

                        &.exile:not(.error) {
                            color: $uva-text-gray;
                        }

                        &:not(.error) {
                            cursor: default;
                        }
                    }

                    .repository {
                        @media #{$wide-screen} {
                            padding-bottom: 0;
                        }
                        @media #{$narrow-screen} {
                            margin-top: 0;
                        }
                    }
                }

                &.identity-highlight {
                    font-weight: bold;
                    background:  ghostwhite;
                }
            }
        }

        //=====================================================================
        // Components - when the list item is open
        //=====================================================================

        .search-list-item.colorized.open {

            > .value,
            > .pair > .value {

                &.field-Title {

                    @media #{$narrow-screen} {
                        box-shadow: $title-scroll-mask;
                    }

                    .title {
                        box-shadow: none;
                    }

                    .repository {
                        img {
                            box-shadow: none;
                        }
                    }
                }
            }
        }

        //=====================================================================
        // Components - when the list item is closed
        //=====================================================================

        .search-list-item.colorized:not(.open) {

            > .value,
            > .pair > .value {

                &.field-Title {

                    @media #{$narrow-screen} {
                        box-shadow: none;
                    }

                    .repository {
                        img {
                            @media #{$narrow-screen} {
                                box-shadow: none;
                            }
                        }
                    }
                }
            }
        }
    }

    //=========================================================================
    // Sections - field highlighting
    //=========================================================================

    .search-list.highlight-fields {

        //=====================================================================
        // Indicate primary field scope - NOTE: testing
        //=====================================================================

        .scope-title:not(.field-Title) {
            @include primary(beige);
        }

        .scope-parts {
            // TODO: ???
        }

        .scope-formats {
            // TODO: ???
        }

        .scope-files {
            @include primary(lightcyan);
        }

        //=====================================================================
        // Indicate secondary field scope - NOTE: testing
        //=====================================================================

        .scope-bibliographic:not(.field-Title) {
            @include secondary(black);
        }

        .scope-remediation {
            @include secondary(red);
        }

        .scope-accessibility {
            @include secondary(limegreen);
        }

        .scope-repository {
            @include secondary(dodgerblue);
        }

        .scope-index {
            @include secondary(hotpink);
        }
    }

    .search-list.mark-types {

        > .value,
        > .pair > .value {

            &.text {
                @include type-marker('text', gray);
            }

            &.textbox {
                @include type-marker('textbox', dodgerblue);
            }

            &.date {
                @include type-marker('date', green);
            }

            &.url {
                @include type-marker('url', blue);
            }

            &.enum {
                @include type-marker('enum', lime);
            }

            &.list {
                @include type-marker('list', red);
            }

            &.array {
                @include type-marker('array', violet);
            }
        }
    }

    //=========================================================================
    // Sections - search scores
    //=========================================================================

    .search-list {

        //=====================================================================
        // Components
        //=====================================================================

        .search-list-item {

            > .label,
            > .pair > .label {

                @include score-fields {
                    box-shadow: 0.375rem 0 0 0.625rem $score-fields-bg;
                }

                @media #{$narrow-screen} {
                    @include score-fields {
                        box-shadow: 0.5rem 0 0 0.5rem $score-fields-bg;
                    }
                }
            }

            > .value,
            > .pair > .value {

                @include score-fields {
                    box-shadow: -0.625rem 0 0 0.625rem $score-fields-bg;
                }

                @media #{$narrow-screen} {
                    @include score-fields {
                        box-shadow: 0.5rem 0 0 0.5rem $score-fields-bg;
                    }
                }

                &.field-Title {

                    .item-score {

                        min-width:     1.75rem;
                        margin:        auto 0;
                        padding:       0.25rem;
                        font-family:   monospace;
                        font-size:     smaller;
                        text-align:    center;
                        word-break:    keep-all;
                        color:         green;
                        background:    white;
                        border:        2px solid green;
                        border-radius: 0.25rem;

                        @media #{$wide-screen} {
                            margin-left: 1rem;
                        }

                        @media #{$medium-width} {
                            margin-left: 0.5rem;
                            margin-top:  $medium-open-pad - $v-shift-half;
                        }

                        @media #{$narrow-screen} {
                            margin-left: 1rem;
                        }

                        &.error {
                            color:        red;
                            border-color: red;
                        }

                        &.disabled {
                            color:        darkgray;
                            border-color: darkgray;
                        }
                    }
                }
            }
        }

        //=====================================================================
        // Components - when the list item is open
        //=====================================================================

        .search-list-item.open {

            > .value,
            > .pair > .value {

                &.field-Title {

                    .item-score {
                        @media #{$wide-screen} {
                            margin-top: $wide-open-pad + $v-shift-half;
                        }
                    }
                }
            }
        }

        //=====================================================================
        // Components - when the list item is colorized
        //=====================================================================

        .search-list-item.colorized {

            > .value,
            > .pair > .value {

                &.field-Title {

                    .item-score {

                        border-radius: 0;

                        @media #{$wide-screen} {
                            box-shadow:
                                -0.875rem  0 0 1.125rem  $root-bg-color;
                        }
                        @media #{$medium-width} {
                            box-shadow:
                                -0.3125rem 0 0 0.9375rem $root-bg-color;
                        }
                        @media #{$narrow-screen} {
                            box-shadow:
                                -0.625rem  0 0 0.625rem  $root-bg-color;
                        }
                    }
                }
            }
        }
    }
}

$column-count: 0;
$next-column:  1;

@function show-($columns: 1) {
    $start-column: $next-column;
    $end-column:   $start-column;
    $columns:      if((not $columns or ($columns == 0)), 1, $columns);
    @if $columns > 1 {
        $end-column: $end-column + $columns;
    }
    $next-column:  $next-column  + $columns;
    $column-count: $column-count + $columns;
    @return #{$start-column}/#{$end-column};
}

@function -hide() {
    @return false;
}

@mixin clean() {
    font-weight: revert;
    background:  revert;
    border:      revert;
    box-shadow:  revert;
}

body.grid-style {

    // Each column is either hidden or given a distinct column slot so that
    // there is a consistent display of columns regardless of whether the item
    // has that given type of metadata or not.
    $field-columns: (
        Format:                 show-(),
        Creator:                show-(),
        Language:               show-(),
        Description:            -hide(),
        Publisher:              show-(),
        Subject:                -hide(),
        Rights:                 -hide(),
        PublicationDate:        show-(),
        CopyrightDate:          -hide(),
        Identifier:             show-(2),
        Related:                -hide(),
        //PublicationDate:      show-(), // moved before Identifier
        //CopyrightDate:        -hide(), // moved before Identifier
        EntryCreated:           -hide(),
        EntryUpdated:           -hide(),
        RecordId:               show-(),
        TitleId:                show-(),
        Repository:             -hide(),
        Collection:             -hide(),
        FormatVersion:          -hide(),
        FormatFeature:          -hide(),
        AccessibilityFeature:   -hide(),
        AccessibilityControl:   -hide(),
        AccessibilityHazard:    -hide(),
        AccessMode:             -hide(),
        SufficientMode:         -hide(),
        AccessibilitySummary:   -hide(),
        RepositoryRecordId:     show-(),
        RetrievalLink:          show-(),
    );

    //=========================================================================
    // Sections
    //=========================================================================

    .search-list {

        grid-template-columns: 1fr;

        .number {
            display: none !important;
        }

        .search-list-item {

            max-height:            unset !important;
            grid-template-columns: repeat($column-count, minmax(5vw,1fr));
            column-gap:            0.5rem;

            //=================================================================
            // Components
            //=================================================================

            > .label,
            > .pair > .label {
                display: none !important;
            }

            > .value:not(.row-1),
            > .pair > .value:not(.row-1),
            > .pair:not(.row-1) > .value {
                display: revert !important;
            }

            > .value,
            > .pair > .value {

                &.textbox {
                    @include clean;
                }

                &.array {
                    grid-template-columns: 1fr;
                    > * {
                        @include clean;
                    }
                }

                &.field-Title {

                    position:       unset;
                    margin-top:     2rem;
                    background:     #eeeeee;
                    grid-column:    1/-1;
                    grid-row:       1/1;
                    pointer-events: none;

                    .repository {
                        img {
                            box-shadow: none;
                        }
                    }
                }

                @each $type in map.keys($field-columns) {
                    &.field-#{$type} {
                        $columns: map-get($field-columns, $type);
                        @if $columns {
                            grid-column: $columns;
                            grid-row:    2/2;
                        } @else {
                            display: none !important;
                        }
                    }
                }
            }
        }
    }
}

body.search-v2,
body.search-v3,
body.aggregate-style {

    .search-list {

        .search-list-item {

            > .value,
            > .pair > .value {

                &.field-Title {

                    .item-date,
                    .item-number {

                        margin-left: 0.5rem;
                        padding:     0 0.5rem;
                        color:       black;
                        background:  whitesmoke;
                        box-shadow:  inset 0 0 0 1px gray;

                        @media #{$not-wide-screen} {
                            padding: 0 0.375rem;
                        }
                    }

                    .item-date {
                        margin-left: 0.75rem;
                        font-weight: normal;
                    }
                }
            }
        }

        .search-list-item.colorized {

            > .value,
            > .pair > .value {

                &.field-Title {

                    .item-date,
                    .item-number {
                        background:  white;
                    }
                }
            }
        }
    }
}

body.search-v2,
body.search-v3 {

    // This is only meaningful for "un-applying" a search style that was set
    // for the "normal" /search results page.
    .restore-button {
        display: none;
    }
}

@mixin fill($r-offset: 2px, $l-offset: 2px, $bg: whitesmoke) {
    background: $bg;
    box-shadow:
                $r-offset  1px 0 2px $bg,
                $r-offset -1px 0 2px $bg,
                -$l-offset  1px 0 2px $bg,
                -$l-offset -1px 0 2px $bg;
}

body.search-v3 {

    .search-list {

        .number {

            .toggle.for-item {
                @media #{$not-narrow-screen} {
                    width:      1.875rem;
                    height:     1.75rem;
                    margin-top: 0;
                }
            }

            // Do not show file counts by default.
            .file-counts {
                display: none;
            }
        }

        .search-list-item {

            @media #{$wide-screen} {
                @include search-item-columns(0.15fr);
            }

            // Probably-temporary divider between metadata for individual parts
            > .label.field-section,
            > .pair > .label.field-section,
            > .pair.field-section > .label,
            > .value.field-section,
            > .pair > .value.field-section,
            > .pair.field-section > .value {

                margin:      0.5rem 0;
                line-height: 1.25;
                font-size:   larger;

                // Don't display the divider if not valid.
                &[data-value="-"],
                &:not([data-value]) {
                    display: none;
                }
            }

            > .label.field-section,
            > .pair > .label.field-section,
            > .pair.field-section > .label {

                @include fill(2rem); // Extend to touch the .value element.

                display:     flex;
                column-gap:  0.5rem;
                font-weight: bolder;

                border-top-left-radius:    0.75rem;
                border-bottom-left-radius: 0.75rem;

                @media #{$narrow-screen} {
                    box-shadow:
                        -1px  1px  0  3px  whitesmoke,
                        -1px -1px  0  3px  whitesmoke;
                }
            }

            > .value.field-section,
            > .pair > .value.field-section,
            > .pair.field-section > .value {

                @include fill(2px);

                height: unset;

                @media #{$narrow-screen} {
                    display: none;
                }

                &.open {
                    .details {
                        display: none;
                    }
                }
            }

            //=================================================================
            // Indentation levels
            //=================================================================

            $part-indent:   0;
            $format-indent: 1rem;
            $file-indent:   2rem;

            > .label,
            > .pair > .label {

                &.field-NewPart   { margin-left: $part-indent; }
                &.field-NewFormat { margin-left: $format-indent; }
                &.field-NewFile   { margin-left: $file-indent; }


                &.scope-parts.scope-formats.scope-files {
                    margin-left: $file-indent;
                }
            }

            > .value,
            > .pair > .value {
                &.scope-parts.scope-formats.scope-files {
                    @media #{$narrow-screen} {
                        margin-left: $file-indent;
                    }
                }
            }
        }
    }

    //=========================================================================
    // Sections - field highlighting
    //=========================================================================

    .search-list.highlight-fields {

        .number {

            display: flex;

            // Due to the way that setupToggleControl() adds the control button
            @media #{$not-narrow-screen} {
                flex-direction:  row-reverse;
                justify-content: flex-end;
            }

            @media #{$wide-screen} {
                padding-top:     0;
            }

            @media #{$narrow-screen} {
                flex-direction:  row;
                justify-content: flex-start;
                margin-right:    -0.75rem;
                padding-top:     1.75rem;
            }

            //=================================================================
            // Elements
            //=================================================================

            .container {
                .toggle.for-item {
                    @media #{$narrow-screen} {
                        margin-top: 0;
                    }
                }
            }

            .toggle.for-item,
            .file-counts {
                align-self: flex-start;
            }

            .toggle.for-item {
                margin-bottom: 0;
                z-index:       $z-raised;
            }

            .file-counts {

                display:               grid;
                grid-template-columns: [count] max-content [format] 1fr;
                column-gap:            0.25rem;

                margin:      0;
                padding:     0.125rem 0.25rem;

                // This gives each file count box a uniform appearance.

                min-width:   3.75rem;
                min-height:  2.25rem;
                line-height: 1.25rem;
                color:       green;
                background:  lightyellow;
                border:      1px solid gray;

                /**
                 * If the previous file count has a lot of lines, this shadow
                 * keeps it from appearing to run into the current file count.
                 */
                @media #{$not-narrow-screen} {
                    box-shadow:   0 -0.5rem 0.5rem 0.25rem $root-bg-color;
                }

                @media #{$wide-screen} {
                    margin-left:  0.75rem;
                    font-size:    small;
                }

                @media #{$medium-width} {
                    margin-left:  0.5rem;
                    font-size:    small;
                }

                @media #{$narrow-screen} {
                    margin-left:  0.5rem;
                    font-size:    medium;
                    max-height:   2.25rem;
                    min-height:   unset;
                    overflow-y:   auto;
                }

                .count,
                .format {
                    @media #{$narrow-screen} {
                        margin: auto 0;
                    }
                }

                .count {
                    text-align: right;
                }

                .format {
                    text-align: left;
                }
            }

            ul.file-counts {

                list-style: none;

                li {
                    display: contents;
                }

                // Narrow the gap between subsequent count/format pairs.
                li + li * {
                    margin-top: -0.125rem;
                }
            }

            //=================================================================
            // When the associated list item is closed.
            //=================================================================

            // Constraining the height makes the file count behave as box that
            // descends from a line that runs through the open/close control
            // and the text of the title.
            &:not(.open) {
                height: 1.5rem;
            }

            //=================================================================
            // When the associated list item is open.
            //=================================================================

            &.open {

                .file-counts {
                    position: sticky;
                    top:      3vh;
                }

                @media #{$narrow-screen} {

                    height: calc(100% - 5.5rem);

                    .toggle.for-item,
                    .file-counts {
                        align-self: flex-start;
                        top:        1rem;
                    }
                }
            }
        }

        // Adjustments due to .number changes:
        .search-list-item {

            @media #{$wide-screen} {
                @include search-item-columns(0.1875fr);
            }

            @media #{$medium-width} {
                @include search-item-columns(0.3125fr);
            }

            @media #{$narrow-screen} {
                margin-left:  -27.5vw;
                margin-right: 27.5vw;
            }

            > .value,
            > .pair > .value {

                &.list,
                &.textbox {

                    @media #{$wide-screen} {
                        max-width: 66vw;
                    }

                    @media #{$medium-width} {
                        max-width: 50vw;
                    }

                    @media #{$narrow-screen} {
                        max-width: 75vw;
                    }
                }
            }
        }
    }
}

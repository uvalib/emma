# app/helpers/layout_helper/page_controls.rb
#
# frozen_string_literal: true
# warn_indent:           true

__loading_begin(__FILE__)

# Control bar which holds action controls appropriate for the current page and
# the current user.
#
module LayoutHelper::PageControls

  include I18nHelper
  include BookshareHelper

  # ===========================================================================
  # :section:
  # ===========================================================================

  public

  # Indicate whether it is appropriate to show page controls.
  #
  # @param [Hash, nil] p              Default: `#request_parameters`.
  #
  def show_page_controls?(p = nil)
    p ||= request_parameters
    !p[:controller].to_s.include?('devise')
  end

  # Render the appropriate partial to insert page controls if they are defined
  # for the current controller/action.
  #
  # @param [Hash, nil] p              Default: `#request_parameters`.
  # @param [Hash]      locals         Passed to `#render`.
  #
  # @return [ActiveSupport::SafeBuffer]
  # @return [nil]
  #
  def render_page_controls(p = nil, locals: {})
    p ||= request_parameters
    partial  = p[:action].to_s
    partial  = Ability::ACTION_ALIAS[partial.to_sym]&.first&.to_s || partial
    partial  = "#{p[:controller]}/page_controls/#{partial}"
    controls = partial_exists?(partial) && render(partial, locals)
    content_tag(:div, controls, class: 'page-controls') if controls.present?
  end

  # Generate a list of controller/action pairs that the current user is able to
  # perform.
  #
  # @param [Class,Symbol,String] model
  # @param [Array<Symbol>]       actions
  #
  # @return [Array<Array<(Symbol,Symbol)>>]
  # @return [nil]
  #
  def page_control_actions(model, *actions)
    if model.is_a?(Class)
      controller = model.to_s.underscore
    else
      controller = model.to_sym
      model      = model.to_s.camelize.constantize
    end
    actions.map { |action|
      [controller, action] if (action = action&.to_sym) && can?(action, model)
    }.compact.presence
  end

  # Generate controls specified by controller/action pairs generated by
  # #page_controls_actions.
  #
  # @param [Array<Array<(Symbol,Symbol)>>] pairs
  # @param [Hash]                          path_opt
  #
  # @return [ActiveSupport::SafeBuffer]
  # @return [nil]
  #
  def page_controls(*pairs, **path_opt)
    html_opt = { class: 'control' }
    pairs.map { |pair|
      link_to_action(*pair, link_opt: html_opt, **path_opt) if pair.present?
    }.compact.join("\n").html_safe.presence
  end

  # page_controls_label
  #
  # @param [String, Symbol, nil] controller   Default: `#params[:controller]`.
  # @param [Hash]                opt          Passed to #i18n_lookup.
  #
  # @return [String]
  # @return [nil]
  #
  def page_controls_label(controller = nil, **opt)
    controller ||= request_parameters[:controller]
    i18n_lookup(controller, 'page_controls.label', **opt)
  end

end

__loading_end(__FILE__)

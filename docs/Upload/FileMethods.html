<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Upload::FileMethods
  
    &mdash; Documentation by YARD 0.9.26
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Upload::FileMethods";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (F)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Upload.html" title="Upload (class)">Upload</a></span></span>
     &raquo; 
    <span class="title">FileMethods</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Upload::FileMethods
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd><span class='object_link'><a href="../FileNaming.html" title="FileNaming (module)">FileNaming</a></span>, <span class='object_link'><a href="WorkflowMethods.html" title="Upload::WorkflowMethods (module)">WorkflowMethods</a></span></dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>app/models/upload/file_methods.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Upload record methods to support Shrine-based file objects uploaded from the client.</p>


  </div>
</div>
<div class="tags">
  

</div>
  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="ONE_TIME_USE_EXPIRATION-constant" class="">ONE_TIME_USE_EXPIRATION =
          <div class="docstring">
  <div class="discussion">
    
<p>The maximum age (in seconds) allowed for download links which are meant to be valid only for a single time.</p>

<p>This should be generous to allow for network delays.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='int'>10</span></pre></dd>
      
        <dt id="DOWNLOAD_EXPIRATION-constant" class="">DOWNLOAD_EXPIRATION =
          <div class="docstring">
  <div class="discussion">
    
<p>The maximum age (in seconds) allowed for download links.</p>

<p>This allows the link to be reused for a while, but not long enough to allow sharing of content URLs for distribution.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='int'>1800</span></pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="../FileNaming.html" title="FileNaming (module)">FileNaming</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../FileNaming.html#STRICT_FORMATS-constant" title="FileNaming::STRICT_FORMATS (constant)">FileNaming::STRICT_FORMATS</a></span></p>

  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="WorkflowMethods.html" title="Upload::WorkflowMethods (module)">WorkflowMethods</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="WorkflowMethods.html#DEFAULT_AUTO_REVIEWABLE-constant" title="Upload::WorkflowMethods::DEFAULT_AUTO_REVIEWABLE (constant)">WorkflowMethods::DEFAULT_AUTO_REVIEWABLE</a></span>, <span class='object_link'><a href="WorkflowMethods.html#DEFAULT_REVIEW_REQUIRED-constant" title="Upload::WorkflowMethods::DEFAULT_REVIEW_REQUIRED (constant)">WorkflowMethods::DEFAULT_REVIEW_REQUIRED</a></span>, <span class='object_link'><a href="WorkflowMethods.html#REVERSE_STATE_GROUP-constant" title="Upload::WorkflowMethods::REVERSE_STATE_GROUP (constant)">WorkflowMethods::REVERSE_STATE_GROUP</a></span>, <span class='object_link'><a href="WorkflowMethods.html#REVERT_DATA_FIELDS-constant" title="Upload::WorkflowMethods::REVERT_DATA_FIELDS (constant)">WorkflowMethods::REVERT_DATA_FIELDS</a></span>, <span class='object_link'><a href="WorkflowMethods.html#STATE_COLUMNS-constant" title="Upload::WorkflowMethods::STATE_COLUMNS (constant)">WorkflowMethods::STATE_COLUMNS</a></span>, <span class='object_link'><a href="WorkflowMethods.html#STATE_GROUP-constant" title="Upload::WorkflowMethods::STATE_GROUP (constant)">WorkflowMethods::STATE_GROUP</a></span>, <span class='object_link'><a href="WorkflowMethods.html#USER_COLUMNS-constant" title="Upload::WorkflowMethods::USER_COLUMNS (constant)">WorkflowMethods::USER_COLUMNS</a></span>, <span class='object_link'><a href="WorkflowMethods.html#WORKFLOW_PHASE_COLUMN-constant" title="Upload::WorkflowMethods::WORKFLOW_PHASE_COLUMN (constant)">WorkflowMethods::WORKFLOW_PHASE_COLUMN</a></span></p>

  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="../Emma/Debug/FormatMethods.html" title="Emma::Debug::FormatMethods (module)">Emma::Debug::FormatMethods</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Emma/Debug/FormatMethods.html#DEBUG_INSPECT_COMMON-constant" title="Emma::Debug::FormatMethods::DEBUG_INSPECT_COMMON (constant)">Emma::Debug::FormatMethods::DEBUG_INSPECT_COMMON</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#DEBUG_INSPECT_MAX-constant" title="Emma::Debug::FormatMethods::DEBUG_INSPECT_MAX (constant)">Emma::Debug::FormatMethods::DEBUG_INSPECT_MAX</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#DEBUG_INSPECT_OMISSION-constant" title="Emma::Debug::FormatMethods::DEBUG_INSPECT_OMISSION (constant)">Emma::Debug::FormatMethods::DEBUG_INSPECT_OMISSION</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#DEBUG_SEPARATOR-constant" title="Emma::Debug::FormatMethods::DEBUG_SEPARATOR (constant)">Emma::Debug::FormatMethods::DEBUG_SEPARATOR</a></span></p>

  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="../Emma/Common.html" title="Emma::Common (module)">Emma::Common</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Emma/Common.html#BOOLEAN_VALUES-constant" title="Emma::Common::BOOLEAN_VALUES (constant)">Emma::Common::BOOLEAN_VALUES</a></span>, <span class='object_link'><a href="../Emma/Common.html#HTML_QUOTES-constant" title="Emma::Common::HTML_QUOTES (constant)">Emma::Common::HTML_QUOTES</a></span>, <span class='object_link'><a href="../Emma/Common.html#INFLECT_PLURAL-constant" title="Emma::Common::INFLECT_PLURAL (constant)">Emma::Common::INFLECT_PLURAL</a></span>, <span class='object_link'><a href="../Emma/Common.html#INFLECT_SINGULAR-constant" title="Emma::Common::INFLECT_SINGULAR (constant)">Emma::Common::INFLECT_SINGULAR</a></span>, <span class='object_link'><a href="../Emma/Common.html#LIST_SEPARATOR-constant" title="Emma::Common::LIST_SEPARATOR (constant)">Emma::Common::LIST_SEPARATOR</a></span>, <span class='object_link'><a href="../Emma/Common.html#PAIR_SEPARATOR-constant" title="Emma::Common::PAIR_SEPARATOR (constant)">Emma::Common::PAIR_SEPARATOR</a></span>, <span class='object_link'><a href="../Emma/Common.html#QUOTE_MARKS-constant" title="Emma::Common::QUOTE_MARKS (constant)">Emma::Common::QUOTE_MARKS</a></span></p>


  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#edit_file-instance_method" title="#edit_file (instance method)">#<strong>edit_file</strong>  &#x21d2; FileUploader::UploadedFile </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Represents a file that was uploaded to a storage as a replacement for the originally-submitted file.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#edit_file_attacher-instance_method" title="#edit_file_attacher (instance method)">#<strong>edit_file_attacher</strong>  &#x21d2; FileUploader::Attacher </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Saves information about the uploaded replacement as an attachment to a record (saving the file data to the :edit_file_data database column).</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#file-instance_method" title="#file (instance method)">#<strong>file</strong>  &#x21d2; FileUploader::UploadedFile </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Represents a file that was uploaded to a storage.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#file_attacher-instance_method" title="#file_attacher (instance method)">#<strong>file_attacher</strong>  &#x21d2; FileUploader::Attacher </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Saves information about the uploaded file as an attachment to a record (saving the file data to the :file_data database column).</p>
</div></span>
  
</li>

    
  </ul>



  
  
  <h3 class="inherited">Attributes included from <span class='object_link'><a href="WorkflowMethods.html" title="Upload::WorkflowMethods (module)">WorkflowMethods</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="WorkflowMethods.html#revert_data-instance_method" title="Upload::WorkflowMethods#revert_data (method)">#revert_data</a></span></p>


  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#active_attached_file-instance_method" title="#active_attached_file (instance method)">#<strong>active_attached_file</strong>  &#x21d2; FileUploader::UploadedFile<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return the attached file currently associated with the record.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#active_file-instance_method" title="#active_file (instance method)">#<strong>active_file</strong>  &#x21d2; FileUploader::UploadedFile<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The uploaded file currently being used with Shrine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#active_file_attacher-instance_method" title="#active_file_attacher (instance method)">#<strong>active_file_attacher</strong>  &#x21d2; FileUploader::Attacher </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The file attacher currently being used with Shrine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#active_file_data-instance_method" title="#active_file_data (instance method)">#<strong>active_file_data</strong>  &#x21d2; String<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The file metadata currently being used with Shrine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#active_filename-instance_method" title="#active_filename (instance method)">#<strong>active_filename</strong>  &#x21d2; String<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Full name of the file currently associated with the record.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#attached_file-instance_method" title="#attached_file (instance method)">#<strong>attached_file</strong>  &#x21d2; FileUploader::UploadedFile<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return the attached file, loading it if necessary (and possible).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete_file-instance_method" title="#delete_file (instance method)">#<strong>delete_file</strong>(no_raise: true, field: nil)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Remove the uploaded file from storage (either :store or :cache).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#download_url-instance_method" title="#download_url (instance method)">#<strong>download_url</strong>(**opt)  &#x21d2; String<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generate a URL to the uploaded file which can be used to download the file to the client browser.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#edit_attached_file-instance_method" title="#edit_attached_file (instance method)">#<strong>edit_attached_file</strong>  &#x21d2; FileUploader::UploadedFile<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return the attached file, loading it if necessary (and possible).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#edit_filename-instance_method" title="#edit_filename (instance method)">#<strong>edit_filename</strong>  &#x21d2; String<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Full name of the file when editing an existing entry.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#fetch_and_upload_file-instance_method" title="#fetch_and_upload_file (instance method)">#<strong>fetch_and_upload_file</strong>(file_path, **opt)  &#x21d2; FileUploader::UploadedFile </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Acquire a file and upload it to storage.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#file_data_column-instance_method" title="#file_data_column (instance method)">#<strong>file_data_column</strong>  &#x21d2; Symbol </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The database column currently associated with uploaded file information used by Shrine.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#filename-instance_method" title="#filename (instance method)">#<strong>filename</strong>  &#x21d2; String<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Full name of the file.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#promote_file-instance_method" title="#promote_file (instance method)">#<strong>promote_file</strong>(no_raise: true)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Move the uploaded file to its final destination.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#s3_object-instance_method" title="#s3_object (instance method)">#<strong>s3_object</strong>  &#x21d2; Aws::S3::Object<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The AWS S3 object for the file.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../FileNaming.html" title="FileNaming (module)">FileNaming</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../FileNaming.html#ext_to_fmt-class_method" title="FileNaming.ext_to_fmt (method)">ext_to_fmt</a></span>, <span class='object_link'><a href="../FileNaming.html#ext_to_fmt-instance_method" title="FileNaming#ext_to_fmt (method)">#ext_to_fmt</a></span>, <span class='object_link'><a href="../FileNaming.html#file_extensions-class_method" title="FileNaming.file_extensions (method)">file_extensions</a></span>, <span class='object_link'><a href="../FileNaming.html#fmt_to_ext-instance_method" title="FileNaming#fmt_to_ext (method)">#fmt_to_ext</a></span>, <span class='object_link'><a href="../FileNaming.html#fmt_to_mime-instance_method" title="FileNaming#fmt_to_mime (method)">#fmt_to_mime</a></span>, <span class='object_link'><a href="../FileNaming.html#format_class-class_method" title="FileNaming.format_class (method)">format_class</a></span>, <span class='object_link'><a href="../FileNaming.html#format_class_instance-class_method" title="FileNaming.format_class_instance (method)">format_class_instance</a></span>, <span class='object_link'><a href="../FileNaming.html#format_classes-class_method" title="FileNaming.format_classes (method)">format_classes</a></span>, <span class='object_link'><a href="../FileNaming.html#mime_to_fmt-class_method" title="FileNaming.mime_to_fmt (method)">mime_to_fmt</a></span>, <span class='object_link'><a href="../FileNaming.html#mime_to_fmt-instance_method" title="FileNaming#mime_to_fmt (method)">#mime_to_fmt</a></span>, <span class='object_link'><a href="../FileNaming.html#mime_types-class_method" title="FileNaming.mime_types (method)">mime_types</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../ZipArchive.html" title="ZipArchive (module)">ZipArchive</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../ZipArchive.html#find_zip_path-instance_method" title="ZipArchive#find_zip_path (method)">#find_zip_path</a></span>, <span class='object_link'><a href="../ZipArchive.html#get_archive_entry-instance_method" title="ZipArchive#get_archive_entry (method)">#get_archive_entry</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Emma/Mime.html" title="Emma::Mime (module)">Emma::Mime</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Emma/Mime.html#ext_to_mime-instance_method" title="Emma::Mime#ext_to_mime (method)">#ext_to_mime</a></span>, <span class='object_link'><a href="../Emma/Mime.html#known_extension%3F-instance_method" title="Emma::Mime#known_extension? (method)">#known_extension?</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="WorkflowMethods.html" title="Upload::WorkflowMethods (module)">WorkflowMethods</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="WorkflowMethods.html#active_state-instance_method" title="Upload::WorkflowMethods#active_state (method)">#active_state</a></span>, <span class='object_link'><a href="WorkflowMethods.html#active_user-instance_method" title="Upload::WorkflowMethods#active_user (method)">#active_user</a></span>, <span class='object_link'><a href="WorkflowMethods.html#auto_reviewable%3F-instance_method" title="Upload::WorkflowMethods#auto_reviewable? (method)">#auto_reviewable?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#begin_editing-instance_method" title="Upload::WorkflowMethods#begin_editing (method)">#begin_editing</a></span>, <span class='object_link'><a href="WorkflowMethods.html#being_created%3F-instance_method" title="Upload::WorkflowMethods#being_created? (method)">#being_created?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#being_indexed%3F-instance_method" title="Upload::WorkflowMethods#being_indexed? (method)">#being_indexed?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#being_modified%3F-instance_method" title="Upload::WorkflowMethods#being_modified? (method)">#being_modified?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#being_removed%3F-instance_method" title="Upload::WorkflowMethods#being_removed? (method)">#being_removed?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#being_submitted%3F-instance_method" title="Upload::WorkflowMethods#being_submitted? (method)">#being_submitted?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#completed%3F-instance_method" title="Upload::WorkflowMethods#completed? (method)">#completed?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#edit_phase-instance_method" title="Upload::WorkflowMethods#edit_phase (method)">#edit_phase</a></span>, <span class='object_link'><a href="WorkflowMethods.html#existing_entry%3F-instance_method" title="Upload::WorkflowMethods#existing_entry? (method)">#existing_entry?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#finish_editing-instance_method" title="Upload::WorkflowMethods#finish_editing (method)">#finish_editing</a></span>, <span class='object_link'><a href="WorkflowMethods.html#get_phase-instance_method" title="Upload::WorkflowMethods#get_phase (method)">#get_phase</a></span>, <span class='object_link'><a href="WorkflowMethods.html#get_revert_data-instance_method" title="Upload::WorkflowMethods#get_revert_data (method)">#get_revert_data</a></span>, <span class='object_link'><a href="WorkflowMethods.html#get_state-instance_method" title="Upload::WorkflowMethods#get_state (method)">#get_state</a></span>, <span class='object_link'><a href="WorkflowMethods.html#in_process%3F-instance_method" title="Upload::WorkflowMethods#in_process? (method)">#in_process?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#new_submission%3F-instance_method" title="Upload::WorkflowMethods#new_submission? (method)">#new_submission?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#phase_column-instance_method" title="Upload::WorkflowMethods#phase_column (method)">#phase_column</a></span>, <span class='object_link'><a href="WorkflowMethods.html#review_required%3F-instance_method" title="Upload::WorkflowMethods#review_required? (method)">#review_required?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#sealed%3F-instance_method" title="Upload::WorkflowMethods#sealed? (method)">#sealed?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#set_phase-instance_method" title="Upload::WorkflowMethods#set_phase (method)">#set_phase</a></span>, <span class='object_link'><a href="WorkflowMethods.html#set_revert_data-instance_method" title="Upload::WorkflowMethods#set_revert_data (method)">#set_revert_data</a></span>, <span class='object_link'><a href="WorkflowMethods.html#set_state-instance_method" title="Upload::WorkflowMethods#set_state (method)">#set_state</a></span>, <span class='object_link'><a href="WorkflowMethods.html#state_column-instance_method" title="Upload::WorkflowMethods#state_column (method)">#state_column</a></span>, <span class='object_link'><a href="WorkflowMethods.html#state_group-instance_method" title="Upload::WorkflowMethods#state_group (method)">#state_group</a></span>, <span class='object_link'><a href="WorkflowMethods.html#state_group-class_method" title="Upload::WorkflowMethods.state_group (method)">state_group</a></span>, <span class='object_link'><a href="WorkflowMethods.html#state_group_label-class_method" title="Upload::WorkflowMethods.state_group_label (method)">state_group_label</a></span>, <span class='object_link'><a href="WorkflowMethods.html#timestamp_column-instance_method" title="Upload::WorkflowMethods#timestamp_column (method)">#timestamp_column</a></span>, <span class='object_link'><a href="WorkflowMethods.html#under_review%3F-instance_method" title="Upload::WorkflowMethods#under_review? (method)">#under_review?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#unsealed%3F-instance_method" title="Upload::WorkflowMethods#unsealed? (method)">#unsealed?</a></span>, <span class='object_link'><a href="WorkflowMethods.html#user_column-instance_method" title="Upload::WorkflowMethods#user_column (method)">#user_column</a></span>, <span class='object_link'><a href="WorkflowMethods.html#workflow_phase-instance_method" title="Upload::WorkflowMethods#workflow_phase (method)">#workflow_phase</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Emma/Debug.html" title="Emma::Debug (module)">Emma::Debug</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Emma/Debug.html#included-class_method" title="Emma::Debug.included (method)">included</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Emma/Debug/OutputMethods.html" title="Emma::Debug::OutputMethods (module)">Emma::Debug::OutputMethods</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Emma/Debug/OutputMethods.html#__debug_exception-instance_method" title="Emma::Debug::OutputMethods#__debug_exception (method)">#__debug_exception</a></span>, <span class='object_link'><a href="../Emma/Debug/OutputMethods.html#__debug_items-instance_method" title="Emma::Debug::OutputMethods#__debug_items (method)">#__debug_items</a></span>, <span class='object_link'><a href="../Emma/Debug/OutputMethods.html#__debug_line-instance_method" title="Emma::Debug::OutputMethods#__debug_line (method)">#__debug_line</a></span>, <span class='object_link'><a href="../Emma/Debug/OutputMethods.html#__debug_request-instance_method" title="Emma::Debug::OutputMethods#__debug_request (method)">#__debug_request</a></span>, <span class='object_link'><a href="../Emma/Debug/OutputMethods.html#__debug_route-instance_method" title="Emma::Debug::OutputMethods#__debug_route (method)">#__debug_route</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Emma/Debug/FormatMethods.html" title="Emma::Debug::FormatMethods (module)">Emma::Debug::FormatMethods</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Emma/Debug/FormatMethods.html#__debug_env_hash-instance_method" title="Emma::Debug::FormatMethods#__debug_env_hash (method)">#__debug_env_hash</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#__debug_header_hash-instance_method" title="Emma::Debug::FormatMethods#__debug_header_hash (method)">#__debug_header_hash</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#__debug_inspect-instance_method" title="Emma::Debug::FormatMethods#__debug_inspect (method)">#__debug_inspect</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#__debug_inspect_item-instance_method" title="Emma::Debug::FormatMethods#__debug_inspect_item (method)">#__debug_inspect_item</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#__debug_inspect_items-instance_method" title="Emma::Debug::FormatMethods#__debug_inspect_items (method)">#__debug_inspect_items</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#__debug_label-instance_method" title="Emma::Debug::FormatMethods#__debug_label (method)">#__debug_label</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#__debug_route_label-instance_method" title="Emma::Debug::FormatMethods#__debug_route_label (method)">#__debug_route_label</a></span>, <span class='object_link'><a href="../Emma/Debug/FormatMethods.html#__debug_session_hash-instance_method" title="Emma::Debug::FormatMethods#__debug_session_hash (method)">#__debug_session_hash</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Emma/Common.html" title="Emma::Common (module)">Emma::Common</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Emma/Common.html#array_string-instance_method" title="Emma::Common#array_string (method)">#array_string</a></span>, <span class='object_link'><a href="../Emma/Common.html#boolean%3F-instance_method" title="Emma::Common#boolean? (method)">#boolean?</a></span>, <span class='object_link'><a href="../Emma/Common.html#build_query_options-instance_method" title="Emma::Common#build_query_options (method)">#build_query_options</a></span>, <span class='object_link'><a href="../Emma/Common.html#calling_method-instance_method" title="Emma::Common#calling_method (method)">#calling_method</a></span>, <span class='object_link'><a href="../Emma/Common.html#digits_only%3F-instance_method" title="Emma::Common#digits_only? (method)">#digits_only?</a></span>, <span class='object_link'><a href="../Emma/Common.html#get_method-instance_method" title="Emma::Common#get_method (method)">#get_method</a></span>, <span class='object_link'><a href="../Emma/Common.html#get_params-instance_method" title="Emma::Common#get_params (method)">#get_params</a></span>, <span class='object_link'><a href="../Emma/Common.html#hash_string-instance_method" title="Emma::Common#hash_string (method)">#hash_string</a></span>, <span class='object_link'><a href="../Emma/Common.html#html_id-instance_method" title="Emma::Common#html_id (method)">#html_id</a></span>, <span class='object_link'><a href="../Emma/Common.html#inflection-instance_method" title="Emma::Common#inflection (method)">#inflection</a></span>, <span class='object_link'><a href="../Emma/Common.html#labelize-instance_method" title="Emma::Common#labelize (method)">#labelize</a></span>, <span class='object_link'><a href="../Emma/Common.html#make_path-instance_method" title="Emma::Common#make_path (method)">#make_path</a></span>, <span class='object_link'><a href="../Emma/Common.html#named_format_references-instance_method" title="Emma::Common#named_format_references (method)">#named_format_references</a></span>, <span class='object_link'><a href="../Emma/Common.html#non_breaking-instance_method" title="Emma::Common#non_breaking (method)">#non_breaking</a></span>, <span class='object_link'><a href="../Emma/Common.html#non_negative-instance_method" title="Emma::Common#non_negative (method)">#non_negative</a></span>, <span class='object_link'><a href="../Emma/Common.html#normalized_list-instance_method" title="Emma::Common#normalized_list (method)">#normalized_list</a></span>, <span class='object_link'><a href="../Emma/Common.html#partition_options-instance_method" title="Emma::Common#partition_options (method)">#partition_options</a></span>, <span class='object_link'><a href="../Emma/Common.html#positive-instance_method" title="Emma::Common#positive (method)">#positive</a></span>, <span class='object_link'><a href="../Emma/Common.html#quote-instance_method" title="Emma::Common#quote (method)">#quote</a></span>, <span class='object_link'><a href="../Emma/Common.html#reject_blanks-instance_method" title="Emma::Common#reject_blanks (method)">#reject_blanks</a></span>, <span class='object_link'><a href="../Emma/Common.html#sanitized_string-instance_method" title="Emma::Common#sanitized_string (method)">#sanitized_string</a></span>, <span class='object_link'><a href="../Emma/Common.html#strip_quotes-instance_method" title="Emma::Common#strip_quotes (method)">#strip_quotes</a></span>, <span class='object_link'><a href="../Emma/Common.html#url_escape-instance_method" title="Emma::Common#url_escape (method)">#url_escape</a></span>, <span class='object_link'><a href="../Emma/Common.html#url_query-instance_method" title="Emma::Common#url_query (method)">#url_query</a></span></p>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="edit_file-instance_method">
  
    #<strong>edit_file</strong>  &#x21d2; <tt>FileUploader::UploadedFile</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Represents a file that was uploaded to a storage as a replacement for the originally-submitted file.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::UploadedFile</tt>)</span>
      
      
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#file-instance_method" title="Upload::FileMethods#file (method)">#file</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 27</span>

<span class='kw'>module</span> <span class='const'><span class='object_link'><a href="../Upload.html" title="Upload (class)">Upload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Upload::FileMethods (module)">FileMethods</a></span></span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../Upload.html" title="Upload (class)">Upload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WorkflowMethods.html" title="Upload::WorkflowMethods (module)">WorkflowMethods</a></span></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileNaming.html" title="FileNaming (module)">FileNaming</a></span></span>

  <span class='comment'># Non-functional hints for RubyMine type checking.
</span>  <span class='comment'># :nocov:
</span>  <span class='kw'>unless</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#ONLY_FOR_DOCUMENTATION-constant" title="ONLY_FOR_DOCUMENTATION (constant)">ONLY_FOR_DOCUMENTATION</a></span></span>

    <span class='comment'># Represents a file that was uploaded to a storage.
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::UploadedFile]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see Shrine::ClassMethods#inherited (Created via Shrine)
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:file</span>

    <span class='comment'># Saves information about the uploaded file as an attachment to a record
</span>    <span class='comment'># (saving the file data to the :file_data database column).
</span>    <span class='comment'>#
</span>    <span class='comment'># The attaching process requires a temporary and a permanent storage to be
</span>    <span class='comment'># registered (by default that&#39;s :cache and :store).
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::Attacher]
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:file_attacher</span>

    <span class='comment'># Represents a file that was uploaded to a storage as a replacement for the
</span>    <span class='comment'># originally-submitted file.
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::UploadedFile]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see #file
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:edit_file</span>

    <span class='comment'># Saves information about the uploaded replacement as an attachment to a
</span>    <span class='comment'># record (saving the file data to the :edit_file_data database column).
</span>    <span class='comment'>#
</span>    <span class='comment'># The attaching process requires a temporary and a permanent storage to be
</span>    <span class='comment'># registered (by default that&#39;s :cache and :store).
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::Attacher]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see #file_attacher
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:edit_file_attacher</span>

  <span class='kw'>end</span>
  <span class='comment'># :nocov:
</span>
  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The maximum age (in seconds) allowed for download links which are meant to
</span>  <span class='comment'># be valid only for a single time.
</span>  <span class='comment'>#
</span>  <span class='comment'># This should be generous to allow for network delays.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Integer]
</span>  <span class='comment'>#
</span>  <span class='const'><span class='object_link'><a href="#ONE_TIME_USE_EXPIRATION-constant" title="Upload::FileMethods::ONE_TIME_USE_EXPIRATION (constant)">ONE_TIME_USE_EXPIRATION</a></span></span> <span class='op'>=</span> <span class='int'>10</span>

  <span class='comment'># The maximum age (in seconds) allowed for download links.
</span>  <span class='comment'>#
</span>  <span class='comment'># This allows the link to be reused for a while, but not long enough to allow
</span>  <span class='comment'># sharing of content URLs for distribution.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Integer]
</span>  <span class='comment'>#
</span>  <span class='const'><span class='object_link'><a href="#DOWNLOAD_EXPIRATION-constant" title="Upload::FileMethods::DOWNLOAD_EXPIRATION (constant)">DOWNLOAD_EXPIRATION</a></span></span> <span class='op'>=</span> <span class='int'>1800</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Fields
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Shrine attachment for :file_data.
</span>  <span class='comment'>#
</span>  <span class='comment'># noinspection RubyResolve
</span>  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>Attachment</span><span class='lparen'>(</span><span class='symbol'>:file</span><span class='rparen'>)</span>

  <span class='comment'># Shrine attachment for :edit_file_data, which is applicable only when
</span>  <span class='comment'># `#phase` is &quot;edit&quot;.
</span>  <span class='comment'>#
</span>  <span class='comment'># noinspection RubyResolve
</span>  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>Attachment</span><span class='lparen'>(</span><span class='symbol'>:edit_file</span><span class='rparen'>)</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Full name of the file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_filename'>filename</span>
    <span class='ivar'>@filename</span> <span class='op'>||=</span> <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file, loading it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
    <span class='id identifier rubyid_file'>file</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file_data'>file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_data'>file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Full name of the file when editing an existing entry.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span>
    <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file, loading it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
    <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>||</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Full name of the file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_filename'>active_filename</span>
    <span class='comment'># noinspection RubyYardReturnMatch
</span>    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span> <span class='op'>||</span> <span class='id identifier rubyid_filename'>filename</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span> <span class='op'>||</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Return the cached file, attaching it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attach_cached'>attach_cached</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_stored?'>stored?</span> <span class='op'>||</span> <span class='id identifier rubyid_file_data'>file_data</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file_data'>file_data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the cached file, attaching it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_attach_cached'>edit_attach_cached</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_stored?'>stored?</span> <span class='op'>||</span> <span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the cached file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_attach_cached'>edit_attach_cached</span> <span class='op'>:</span> <span class='id identifier rubyid_attach_cached'>attach_cached</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Move the uploaded file to its final destination.
</span>  <span class='comment'>#
</span>  <span class='comment'># If the file is in :cache it will be moved to :store.  If it&#39;s already in
</span>  <span class='comment'># :store then this is a no-op.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *false*, re-raise exceptions.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_promote_file'>promote_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_promote_cached_file'>promote_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='id identifier rubyid_no_raise'>no_raise</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Remove the uploaded file from storage (either :store or :cache).
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *false*, re-raise exceptions.
</span>  <span class='comment'># @param [Symbol] field             Either :file_data or :edit_file_data;
</span>  <span class='comment'>#                                     otherwise the field is determined by
</span>  <span class='comment'>#                                     the phase.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_delete_file'>delete_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>field:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_destroyed?'>destroyed?</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_field'>field</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
      <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:edit_file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
      <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Generate a URL to the uploaded file which can be used to download the file
</span>  <span class='comment'># to the client browser.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Hash] opt                 Passed to Shrine::UploadedFile#url.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_download_url'>download_url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:expires_in</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'><span class='object_link'><a href="#ONE_TIME_USE_EXPIRATION-constant" title="Upload::FileMethods::ONE_TIME_USE_EXPIRATION (constant)">ONE_TIME_USE_EXPIRATION</a></span></span>
    <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_url'>url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># The AWS S3 object for the file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Aws::S3::Object, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_s3_object'>s3_object</span>
    <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_storage'>storage</span><span class='op'>&amp;.</span><span class='id identifier rubyid_object'>object</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Acquire a file and upload it to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] file_path
</span>  <span class='comment'># @param [Hash]   opt               Passed to FileUploader::Attacher#attach
</span>  <span class='comment'>#                                     except for:
</span>  <span class='comment'>#
</span>  <span class='comment'># @option [Symbol] :meth            Calling method (for logging).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='comment'># == Usage Notes
</span>  <span class='comment'># This method is not necessary for an Upload instance which is persisted to
</span>  <span class='comment'># the database because Shrine adds event handlers which cause the file to be
</span>  <span class='comment'># copied to storage.  This method is allows this action for a &quot;free-standing&quot;
</span>  <span class='comment'># Upload instance (without needing to execute #save in order to engage Shrine
</span>  <span class='comment'># event handlers to copy the file to storage).
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_fetch_and_upload_file'>fetch_and_upload_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_meth'>meth</span>   <span class='op'>=</span> <span class='id identifier rubyid_opt'>opt</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:meth</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid___method__'>__method__</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_file_path'>file_path</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^https?:</span><span class='regexp_end'>/</span></span>
        <span class='id identifier rubyid_upload_remote_file'>upload_remote_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_upload_local_file'>upload_local_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>
      <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_size'>size</span>      <span class='op'>||</span> <span class='int'>0</span>
      <span class='id identifier rubyid_type'>type</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_mime_type'>mime_type</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unknown MIME type</span><span class='tstring_end'>&#39;</span></span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_meth'>meth</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_size'>size</span><span class='embexpr_end'>}</span><span class='tstring_content'> bytes) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_result'>result</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Options for Down#open.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Hash]
</span>  <span class='comment'>#
</span>  <span class='comment'># @see Down::NetHttp#initialize
</span>  <span class='comment'># @see Down::NetHttp#open
</span>  <span class='comment'># @see Down::NetHttp#create_net_http
</span>  <span class='comment'>#
</span>  <span class='const'>DOWN_OPEN_OPTIONS</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='label'>read_timeout:</span> <span class='int'>60</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_deep_freeze'>deep_freeze</span>

  <span class='comment'># Acquire a remote file and copy it to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url
</span>  <span class='comment'># @param [Hash]   opt     Passed to FileUploader::Attacher#attach except for:
</span>  <span class='comment'>#
</span>  <span class='comment'># @option opt [Integer] :read_retry
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_upload_remote_file'>upload_remote_file</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='comment'># @type [Down::ChunkedIO] io
</span>    <span class='id identifier rubyid_io'>io</span> <span class='op'>=</span> <span class='const'>Down</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='op'>**</span><span class='const'>DOWN_OPEN_OPTIONS</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>filename</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_attach'>attach</span><span class='lparen'>(</span><span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!!! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span>
  <span class='kw'>ensure</span>
    <span class='comment'># noinspection RubyScope
</span>    <span class='id identifier rubyid_io'>io</span><span class='op'>&amp;.</span><span class='id identifier rubyid_close'>close</span>
  <span class='kw'>end</span>

  <span class='comment'># Copy a local file to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] path
</span>  <span class='comment'># @param [Hash]   opt               Passed to FileUploader::Attacher#attach
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_upload_local_file'>upload_local_file</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_io'>io</span><span class='op'>|</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_attach'>attach</span><span class='lparen'>(</span><span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!!! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The database column currently associated with uploaded file information
</span>  <span class='comment'># used by Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Symbol]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_data_column'>file_data_column</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='symbol'>:edit_file_data</span> <span class='op'>:</span> <span class='symbol'>:file_data</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The uploaded file currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file'>active_file</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>:</span> <span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># The file attacher currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::Attacher]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span> <span class='op'>:</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span>
  <span class='kw'>end</span>

  <span class='comment'># The file metadata currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file_data'>active_file_data</span>
    <span class='kw'>self</span><span class='lbracket'>[</span><span class='id identifier rubyid_file_data_column'>file_data_column</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Validations
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Indicate whether the attached file is valid.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attached_file_valid?'>attached_file_valid?</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_file'>active_file</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_validate'>validate</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span>
      <span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='symbol'>:file</span><span class='comma'>,</span> <span class='symbol'>:invalid</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Callbacks
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Make a debug output note to mark when a callback has occurred.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Symbol] type
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='comment'># == Usage Notes
</span>  <span class='comment'>#
</span>  <span class='comment'># :before_save # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_before_save
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#save
</span>  <span class='comment'>#
</span>  <span class='comment'># :after_commit, on: %i[create update] # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_after_save
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#finalize
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#destroy_previous
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#promote_cached
</span>  <span class='comment'>#       Shrine::Attacher::InstanceMethods#promote
</span>  <span class='comment'>#   Shrine::Plugins::Activerecord::AttacherMethods#activerecord_persist
</span>  <span class='comment'>#     ActiveRecord::Persistence#save
</span>  <span class='comment'>#
</span>  <span class='comment'># :after_commit, on: %i[destroy] # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_after_destroy
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#destroy_attached
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#destroy
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_note_cb'>note_cb</span><span class='lparen'>(</span><span class='id identifier rubyid_type'>type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_line'>__debug_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*** UPLOAD CALLBACK </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_content'> ***</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Finalize a file upload by promoting the :cache file to a :store file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *true*, don&#39;t re-raise exceptions.
</span>  <span class='comment'># @param [Boolean] keep_cached      If *true*, don&#39;t delete the original.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_promote_cached_file'>promote_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>keep_cached:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_old_file'>old_file</span>   <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_keep_cached'>keep_cached</span>
    <span class='id identifier rubyid_old_file'>old_file</span> <span class='op'>&amp;&amp;=</span> <span class='id identifier rubyid_active_file'>active_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_data'>data</span>
    <span class='id identifier rubyid_old_file'>old_file</span> <span class='op'>&amp;&amp;=</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>UploadedFile</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_old_file'>old_file</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_promote'>promote</span>
    <span class='id identifier rubyid_old_file'>old_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_delete'>delete</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># Finalize a deletion by the removing the file from :cache and/or :store.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *true*, don&#39;t re-raise exceptions.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_delete_cached_file'>delete_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Callbacks
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='comment'># Add a log message for an exception.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Exception] excp
</span>  <span class='comment'># @param [Symbol]    meth           Calling method.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_excp'>excp</span><span class='comma'>,</span> <span class='id identifier rubyid_meth'>meth</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_error'>error</span> <span class='op'>=</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_excp'>excp</span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>FileNotFound</span>      <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>FILE_NOT_FOUND</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>InvalidFile</span>       <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>INVALID_FILE</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>AttachmentChanged</span> <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ATTACHMENT_CHANGED</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>Error</span>             <span class='kw'>then</span> <span class='id identifier rubyid_error'>error</span>   <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unexpected Shrine error</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>else</span>                                <span class='id identifier rubyid_error'>error</span>   <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_excp'>excp</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> unexpected</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span> <span class='op'>?</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='op'>::</span><span class='const'>ERROR</span> <span class='op'>:</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='op'>::</span><span class='const'>WARN</span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_meth'>meth</span> <span class='op'>||</span> <span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_excp'>excp</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> [</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span> <span class='op'>||</span> <span class='id identifier rubyid_warning'>warning</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="edit_file_attacher-instance_method">
  
    #<strong>edit_file_attacher</strong>  &#x21d2; <tt>FileUploader::Attacher</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Saves information about the uploaded replacement as an attachment to a record (saving the file data to the :edit_file_data database column).</p>

<p>The attaching process requires a temporary and a permanent storage to be registered (by default that&#39;s :cache and :store).</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::Attacher</tt>)</span>
      
      
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#file_attacher-instance_method" title="Upload::FileMethods#file_attacher (method)">#file_attacher</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 27</span>

<span class='kw'>module</span> <span class='const'><span class='object_link'><a href="../Upload.html" title="Upload (class)">Upload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Upload::FileMethods (module)">FileMethods</a></span></span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../Upload.html" title="Upload (class)">Upload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WorkflowMethods.html" title="Upload::WorkflowMethods (module)">WorkflowMethods</a></span></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileNaming.html" title="FileNaming (module)">FileNaming</a></span></span>

  <span class='comment'># Non-functional hints for RubyMine type checking.
</span>  <span class='comment'># :nocov:
</span>  <span class='kw'>unless</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#ONLY_FOR_DOCUMENTATION-constant" title="ONLY_FOR_DOCUMENTATION (constant)">ONLY_FOR_DOCUMENTATION</a></span></span>

    <span class='comment'># Represents a file that was uploaded to a storage.
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::UploadedFile]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see Shrine::ClassMethods#inherited (Created via Shrine)
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:file</span>

    <span class='comment'># Saves information about the uploaded file as an attachment to a record
</span>    <span class='comment'># (saving the file data to the :file_data database column).
</span>    <span class='comment'>#
</span>    <span class='comment'># The attaching process requires a temporary and a permanent storage to be
</span>    <span class='comment'># registered (by default that&#39;s :cache and :store).
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::Attacher]
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:file_attacher</span>

    <span class='comment'># Represents a file that was uploaded to a storage as a replacement for the
</span>    <span class='comment'># originally-submitted file.
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::UploadedFile]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see #file
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:edit_file</span>

    <span class='comment'># Saves information about the uploaded replacement as an attachment to a
</span>    <span class='comment'># record (saving the file data to the :edit_file_data database column).
</span>    <span class='comment'>#
</span>    <span class='comment'># The attaching process requires a temporary and a permanent storage to be
</span>    <span class='comment'># registered (by default that&#39;s :cache and :store).
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::Attacher]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see #file_attacher
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:edit_file_attacher</span>

  <span class='kw'>end</span>
  <span class='comment'># :nocov:
</span>
  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The maximum age (in seconds) allowed for download links which are meant to
</span>  <span class='comment'># be valid only for a single time.
</span>  <span class='comment'>#
</span>  <span class='comment'># This should be generous to allow for network delays.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Integer]
</span>  <span class='comment'>#
</span>  <span class='const'><span class='object_link'><a href="#ONE_TIME_USE_EXPIRATION-constant" title="Upload::FileMethods::ONE_TIME_USE_EXPIRATION (constant)">ONE_TIME_USE_EXPIRATION</a></span></span> <span class='op'>=</span> <span class='int'>10</span>

  <span class='comment'># The maximum age (in seconds) allowed for download links.
</span>  <span class='comment'>#
</span>  <span class='comment'># This allows the link to be reused for a while, but not long enough to allow
</span>  <span class='comment'># sharing of content URLs for distribution.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Integer]
</span>  <span class='comment'>#
</span>  <span class='const'><span class='object_link'><a href="#DOWNLOAD_EXPIRATION-constant" title="Upload::FileMethods::DOWNLOAD_EXPIRATION (constant)">DOWNLOAD_EXPIRATION</a></span></span> <span class='op'>=</span> <span class='int'>1800</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Fields
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Shrine attachment for :file_data.
</span>  <span class='comment'>#
</span>  <span class='comment'># noinspection RubyResolve
</span>  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>Attachment</span><span class='lparen'>(</span><span class='symbol'>:file</span><span class='rparen'>)</span>

  <span class='comment'># Shrine attachment for :edit_file_data, which is applicable only when
</span>  <span class='comment'># `#phase` is &quot;edit&quot;.
</span>  <span class='comment'>#
</span>  <span class='comment'># noinspection RubyResolve
</span>  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>Attachment</span><span class='lparen'>(</span><span class='symbol'>:edit_file</span><span class='rparen'>)</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Full name of the file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_filename'>filename</span>
    <span class='ivar'>@filename</span> <span class='op'>||=</span> <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file, loading it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
    <span class='id identifier rubyid_file'>file</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file_data'>file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_data'>file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Full name of the file when editing an existing entry.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span>
    <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file, loading it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
    <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>||</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Full name of the file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_filename'>active_filename</span>
    <span class='comment'># noinspection RubyYardReturnMatch
</span>    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span> <span class='op'>||</span> <span class='id identifier rubyid_filename'>filename</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span> <span class='op'>||</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Return the cached file, attaching it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attach_cached'>attach_cached</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_stored?'>stored?</span> <span class='op'>||</span> <span class='id identifier rubyid_file_data'>file_data</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file_data'>file_data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the cached file, attaching it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_attach_cached'>edit_attach_cached</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_stored?'>stored?</span> <span class='op'>||</span> <span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the cached file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_attach_cached'>edit_attach_cached</span> <span class='op'>:</span> <span class='id identifier rubyid_attach_cached'>attach_cached</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Move the uploaded file to its final destination.
</span>  <span class='comment'>#
</span>  <span class='comment'># If the file is in :cache it will be moved to :store.  If it&#39;s already in
</span>  <span class='comment'># :store then this is a no-op.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *false*, re-raise exceptions.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_promote_file'>promote_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_promote_cached_file'>promote_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='id identifier rubyid_no_raise'>no_raise</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Remove the uploaded file from storage (either :store or :cache).
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *false*, re-raise exceptions.
</span>  <span class='comment'># @param [Symbol] field             Either :file_data or :edit_file_data;
</span>  <span class='comment'>#                                     otherwise the field is determined by
</span>  <span class='comment'>#                                     the phase.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_delete_file'>delete_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>field:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_destroyed?'>destroyed?</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_field'>field</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
      <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:edit_file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
      <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Generate a URL to the uploaded file which can be used to download the file
</span>  <span class='comment'># to the client browser.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Hash] opt                 Passed to Shrine::UploadedFile#url.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_download_url'>download_url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:expires_in</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'><span class='object_link'><a href="#ONE_TIME_USE_EXPIRATION-constant" title="Upload::FileMethods::ONE_TIME_USE_EXPIRATION (constant)">ONE_TIME_USE_EXPIRATION</a></span></span>
    <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_url'>url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># The AWS S3 object for the file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Aws::S3::Object, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_s3_object'>s3_object</span>
    <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_storage'>storage</span><span class='op'>&amp;.</span><span class='id identifier rubyid_object'>object</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Acquire a file and upload it to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] file_path
</span>  <span class='comment'># @param [Hash]   opt               Passed to FileUploader::Attacher#attach
</span>  <span class='comment'>#                                     except for:
</span>  <span class='comment'>#
</span>  <span class='comment'># @option [Symbol] :meth            Calling method (for logging).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='comment'># == Usage Notes
</span>  <span class='comment'># This method is not necessary for an Upload instance which is persisted to
</span>  <span class='comment'># the database because Shrine adds event handlers which cause the file to be
</span>  <span class='comment'># copied to storage.  This method is allows this action for a &quot;free-standing&quot;
</span>  <span class='comment'># Upload instance (without needing to execute #save in order to engage Shrine
</span>  <span class='comment'># event handlers to copy the file to storage).
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_fetch_and_upload_file'>fetch_and_upload_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_meth'>meth</span>   <span class='op'>=</span> <span class='id identifier rubyid_opt'>opt</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:meth</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid___method__'>__method__</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_file_path'>file_path</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^https?:</span><span class='regexp_end'>/</span></span>
        <span class='id identifier rubyid_upload_remote_file'>upload_remote_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_upload_local_file'>upload_local_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>
      <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_size'>size</span>      <span class='op'>||</span> <span class='int'>0</span>
      <span class='id identifier rubyid_type'>type</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_mime_type'>mime_type</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unknown MIME type</span><span class='tstring_end'>&#39;</span></span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_meth'>meth</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_size'>size</span><span class='embexpr_end'>}</span><span class='tstring_content'> bytes) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_result'>result</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Options for Down#open.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Hash]
</span>  <span class='comment'>#
</span>  <span class='comment'># @see Down::NetHttp#initialize
</span>  <span class='comment'># @see Down::NetHttp#open
</span>  <span class='comment'># @see Down::NetHttp#create_net_http
</span>  <span class='comment'>#
</span>  <span class='const'>DOWN_OPEN_OPTIONS</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='label'>read_timeout:</span> <span class='int'>60</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_deep_freeze'>deep_freeze</span>

  <span class='comment'># Acquire a remote file and copy it to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url
</span>  <span class='comment'># @param [Hash]   opt     Passed to FileUploader::Attacher#attach except for:
</span>  <span class='comment'>#
</span>  <span class='comment'># @option opt [Integer] :read_retry
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_upload_remote_file'>upload_remote_file</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='comment'># @type [Down::ChunkedIO] io
</span>    <span class='id identifier rubyid_io'>io</span> <span class='op'>=</span> <span class='const'>Down</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='op'>**</span><span class='const'>DOWN_OPEN_OPTIONS</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>filename</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_attach'>attach</span><span class='lparen'>(</span><span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!!! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span>
  <span class='kw'>ensure</span>
    <span class='comment'># noinspection RubyScope
</span>    <span class='id identifier rubyid_io'>io</span><span class='op'>&amp;.</span><span class='id identifier rubyid_close'>close</span>
  <span class='kw'>end</span>

  <span class='comment'># Copy a local file to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] path
</span>  <span class='comment'># @param [Hash]   opt               Passed to FileUploader::Attacher#attach
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_upload_local_file'>upload_local_file</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_io'>io</span><span class='op'>|</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_attach'>attach</span><span class='lparen'>(</span><span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!!! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The database column currently associated with uploaded file information
</span>  <span class='comment'># used by Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Symbol]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_data_column'>file_data_column</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='symbol'>:edit_file_data</span> <span class='op'>:</span> <span class='symbol'>:file_data</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The uploaded file currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file'>active_file</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>:</span> <span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># The file attacher currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::Attacher]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span> <span class='op'>:</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span>
  <span class='kw'>end</span>

  <span class='comment'># The file metadata currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file_data'>active_file_data</span>
    <span class='kw'>self</span><span class='lbracket'>[</span><span class='id identifier rubyid_file_data_column'>file_data_column</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Validations
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Indicate whether the attached file is valid.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attached_file_valid?'>attached_file_valid?</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_file'>active_file</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_validate'>validate</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span>
      <span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='symbol'>:file</span><span class='comma'>,</span> <span class='symbol'>:invalid</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Callbacks
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Make a debug output note to mark when a callback has occurred.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Symbol] type
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='comment'># == Usage Notes
</span>  <span class='comment'>#
</span>  <span class='comment'># :before_save # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_before_save
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#save
</span>  <span class='comment'>#
</span>  <span class='comment'># :after_commit, on: %i[create update] # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_after_save
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#finalize
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#destroy_previous
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#promote_cached
</span>  <span class='comment'>#       Shrine::Attacher::InstanceMethods#promote
</span>  <span class='comment'>#   Shrine::Plugins::Activerecord::AttacherMethods#activerecord_persist
</span>  <span class='comment'>#     ActiveRecord::Persistence#save
</span>  <span class='comment'>#
</span>  <span class='comment'># :after_commit, on: %i[destroy] # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_after_destroy
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#destroy_attached
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#destroy
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_note_cb'>note_cb</span><span class='lparen'>(</span><span class='id identifier rubyid_type'>type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_line'>__debug_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*** UPLOAD CALLBACK </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_content'> ***</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Finalize a file upload by promoting the :cache file to a :store file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *true*, don&#39;t re-raise exceptions.
</span>  <span class='comment'># @param [Boolean] keep_cached      If *true*, don&#39;t delete the original.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_promote_cached_file'>promote_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>keep_cached:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_old_file'>old_file</span>   <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_keep_cached'>keep_cached</span>
    <span class='id identifier rubyid_old_file'>old_file</span> <span class='op'>&amp;&amp;=</span> <span class='id identifier rubyid_active_file'>active_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_data'>data</span>
    <span class='id identifier rubyid_old_file'>old_file</span> <span class='op'>&amp;&amp;=</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>UploadedFile</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_old_file'>old_file</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_promote'>promote</span>
    <span class='id identifier rubyid_old_file'>old_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_delete'>delete</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># Finalize a deletion by the removing the file from :cache and/or :store.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *true*, don&#39;t re-raise exceptions.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_delete_cached_file'>delete_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Callbacks
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='comment'># Add a log message for an exception.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Exception] excp
</span>  <span class='comment'># @param [Symbol]    meth           Calling method.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_excp'>excp</span><span class='comma'>,</span> <span class='id identifier rubyid_meth'>meth</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_error'>error</span> <span class='op'>=</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_excp'>excp</span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>FileNotFound</span>      <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>FILE_NOT_FOUND</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>InvalidFile</span>       <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>INVALID_FILE</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>AttachmentChanged</span> <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ATTACHMENT_CHANGED</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>Error</span>             <span class='kw'>then</span> <span class='id identifier rubyid_error'>error</span>   <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unexpected Shrine error</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>else</span>                                <span class='id identifier rubyid_error'>error</span>   <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_excp'>excp</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> unexpected</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span> <span class='op'>?</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='op'>::</span><span class='const'>ERROR</span> <span class='op'>:</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='op'>::</span><span class='const'>WARN</span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_meth'>meth</span> <span class='op'>||</span> <span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_excp'>excp</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> [</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span> <span class='op'>||</span> <span class='id identifier rubyid_warning'>warning</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="file-instance_method">
  
    #<strong>file</strong>  &#x21d2; <tt>FileUploader::UploadedFile</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Represents a file that was uploaded to a storage.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::UploadedFile</tt>)</span>
      
      
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li>(Created via Shrine)</li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 27</span>

<span class='kw'>module</span> <span class='const'><span class='object_link'><a href="../Upload.html" title="Upload (class)">Upload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Upload::FileMethods (module)">FileMethods</a></span></span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../Upload.html" title="Upload (class)">Upload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WorkflowMethods.html" title="Upload::WorkflowMethods (module)">WorkflowMethods</a></span></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileNaming.html" title="FileNaming (module)">FileNaming</a></span></span>

  <span class='comment'># Non-functional hints for RubyMine type checking.
</span>  <span class='comment'># :nocov:
</span>  <span class='kw'>unless</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#ONLY_FOR_DOCUMENTATION-constant" title="ONLY_FOR_DOCUMENTATION (constant)">ONLY_FOR_DOCUMENTATION</a></span></span>

    <span class='comment'># Represents a file that was uploaded to a storage.
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::UploadedFile]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see Shrine::ClassMethods#inherited (Created via Shrine)
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:file</span>

    <span class='comment'># Saves information about the uploaded file as an attachment to a record
</span>    <span class='comment'># (saving the file data to the :file_data database column).
</span>    <span class='comment'>#
</span>    <span class='comment'># The attaching process requires a temporary and a permanent storage to be
</span>    <span class='comment'># registered (by default that&#39;s :cache and :store).
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::Attacher]
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:file_attacher</span>

    <span class='comment'># Represents a file that was uploaded to a storage as a replacement for the
</span>    <span class='comment'># originally-submitted file.
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::UploadedFile]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see #file
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:edit_file</span>

    <span class='comment'># Saves information about the uploaded replacement as an attachment to a
</span>    <span class='comment'># record (saving the file data to the :edit_file_data database column).
</span>    <span class='comment'>#
</span>    <span class='comment'># The attaching process requires a temporary and a permanent storage to be
</span>    <span class='comment'># registered (by default that&#39;s :cache and :store).
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::Attacher]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see #file_attacher
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:edit_file_attacher</span>

  <span class='kw'>end</span>
  <span class='comment'># :nocov:
</span>
  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The maximum age (in seconds) allowed for download links which are meant to
</span>  <span class='comment'># be valid only for a single time.
</span>  <span class='comment'>#
</span>  <span class='comment'># This should be generous to allow for network delays.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Integer]
</span>  <span class='comment'>#
</span>  <span class='const'><span class='object_link'><a href="#ONE_TIME_USE_EXPIRATION-constant" title="Upload::FileMethods::ONE_TIME_USE_EXPIRATION (constant)">ONE_TIME_USE_EXPIRATION</a></span></span> <span class='op'>=</span> <span class='int'>10</span>

  <span class='comment'># The maximum age (in seconds) allowed for download links.
</span>  <span class='comment'>#
</span>  <span class='comment'># This allows the link to be reused for a while, but not long enough to allow
</span>  <span class='comment'># sharing of content URLs for distribution.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Integer]
</span>  <span class='comment'>#
</span>  <span class='const'><span class='object_link'><a href="#DOWNLOAD_EXPIRATION-constant" title="Upload::FileMethods::DOWNLOAD_EXPIRATION (constant)">DOWNLOAD_EXPIRATION</a></span></span> <span class='op'>=</span> <span class='int'>1800</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Fields
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Shrine attachment for :file_data.
</span>  <span class='comment'>#
</span>  <span class='comment'># noinspection RubyResolve
</span>  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>Attachment</span><span class='lparen'>(</span><span class='symbol'>:file</span><span class='rparen'>)</span>

  <span class='comment'># Shrine attachment for :edit_file_data, which is applicable only when
</span>  <span class='comment'># `#phase` is &quot;edit&quot;.
</span>  <span class='comment'>#
</span>  <span class='comment'># noinspection RubyResolve
</span>  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>Attachment</span><span class='lparen'>(</span><span class='symbol'>:edit_file</span><span class='rparen'>)</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Full name of the file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_filename'>filename</span>
    <span class='ivar'>@filename</span> <span class='op'>||=</span> <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file, loading it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
    <span class='id identifier rubyid_file'>file</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file_data'>file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_data'>file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Full name of the file when editing an existing entry.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span>
    <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file, loading it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
    <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>||</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Full name of the file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_filename'>active_filename</span>
    <span class='comment'># noinspection RubyYardReturnMatch
</span>    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span> <span class='op'>||</span> <span class='id identifier rubyid_filename'>filename</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span> <span class='op'>||</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Return the cached file, attaching it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attach_cached'>attach_cached</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_stored?'>stored?</span> <span class='op'>||</span> <span class='id identifier rubyid_file_data'>file_data</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file_data'>file_data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the cached file, attaching it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_attach_cached'>edit_attach_cached</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_stored?'>stored?</span> <span class='op'>||</span> <span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the cached file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_attach_cached'>edit_attach_cached</span> <span class='op'>:</span> <span class='id identifier rubyid_attach_cached'>attach_cached</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Move the uploaded file to its final destination.
</span>  <span class='comment'>#
</span>  <span class='comment'># If the file is in :cache it will be moved to :store.  If it&#39;s already in
</span>  <span class='comment'># :store then this is a no-op.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *false*, re-raise exceptions.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_promote_file'>promote_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_promote_cached_file'>promote_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='id identifier rubyid_no_raise'>no_raise</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Remove the uploaded file from storage (either :store or :cache).
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *false*, re-raise exceptions.
</span>  <span class='comment'># @param [Symbol] field             Either :file_data or :edit_file_data;
</span>  <span class='comment'>#                                     otherwise the field is determined by
</span>  <span class='comment'>#                                     the phase.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_delete_file'>delete_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>field:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_destroyed?'>destroyed?</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_field'>field</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
      <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:edit_file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
      <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Generate a URL to the uploaded file which can be used to download the file
</span>  <span class='comment'># to the client browser.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Hash] opt                 Passed to Shrine::UploadedFile#url.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_download_url'>download_url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:expires_in</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'><span class='object_link'><a href="#ONE_TIME_USE_EXPIRATION-constant" title="Upload::FileMethods::ONE_TIME_USE_EXPIRATION (constant)">ONE_TIME_USE_EXPIRATION</a></span></span>
    <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_url'>url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># The AWS S3 object for the file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Aws::S3::Object, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_s3_object'>s3_object</span>
    <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_storage'>storage</span><span class='op'>&amp;.</span><span class='id identifier rubyid_object'>object</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Acquire a file and upload it to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] file_path
</span>  <span class='comment'># @param [Hash]   opt               Passed to FileUploader::Attacher#attach
</span>  <span class='comment'>#                                     except for:
</span>  <span class='comment'>#
</span>  <span class='comment'># @option [Symbol] :meth            Calling method (for logging).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='comment'># == Usage Notes
</span>  <span class='comment'># This method is not necessary for an Upload instance which is persisted to
</span>  <span class='comment'># the database because Shrine adds event handlers which cause the file to be
</span>  <span class='comment'># copied to storage.  This method is allows this action for a &quot;free-standing&quot;
</span>  <span class='comment'># Upload instance (without needing to execute #save in order to engage Shrine
</span>  <span class='comment'># event handlers to copy the file to storage).
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_fetch_and_upload_file'>fetch_and_upload_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_meth'>meth</span>   <span class='op'>=</span> <span class='id identifier rubyid_opt'>opt</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:meth</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid___method__'>__method__</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_file_path'>file_path</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^https?:</span><span class='regexp_end'>/</span></span>
        <span class='id identifier rubyid_upload_remote_file'>upload_remote_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_upload_local_file'>upload_local_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>
      <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_size'>size</span>      <span class='op'>||</span> <span class='int'>0</span>
      <span class='id identifier rubyid_type'>type</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_mime_type'>mime_type</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unknown MIME type</span><span class='tstring_end'>&#39;</span></span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_meth'>meth</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_size'>size</span><span class='embexpr_end'>}</span><span class='tstring_content'> bytes) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_result'>result</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Options for Down#open.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Hash]
</span>  <span class='comment'>#
</span>  <span class='comment'># @see Down::NetHttp#initialize
</span>  <span class='comment'># @see Down::NetHttp#open
</span>  <span class='comment'># @see Down::NetHttp#create_net_http
</span>  <span class='comment'>#
</span>  <span class='const'>DOWN_OPEN_OPTIONS</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='label'>read_timeout:</span> <span class='int'>60</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_deep_freeze'>deep_freeze</span>

  <span class='comment'># Acquire a remote file and copy it to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url
</span>  <span class='comment'># @param [Hash]   opt     Passed to FileUploader::Attacher#attach except for:
</span>  <span class='comment'>#
</span>  <span class='comment'># @option opt [Integer] :read_retry
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_upload_remote_file'>upload_remote_file</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='comment'># @type [Down::ChunkedIO] io
</span>    <span class='id identifier rubyid_io'>io</span> <span class='op'>=</span> <span class='const'>Down</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='op'>**</span><span class='const'>DOWN_OPEN_OPTIONS</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>filename</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_attach'>attach</span><span class='lparen'>(</span><span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!!! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span>
  <span class='kw'>ensure</span>
    <span class='comment'># noinspection RubyScope
</span>    <span class='id identifier rubyid_io'>io</span><span class='op'>&amp;.</span><span class='id identifier rubyid_close'>close</span>
  <span class='kw'>end</span>

  <span class='comment'># Copy a local file to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] path
</span>  <span class='comment'># @param [Hash]   opt               Passed to FileUploader::Attacher#attach
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_upload_local_file'>upload_local_file</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_io'>io</span><span class='op'>|</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_attach'>attach</span><span class='lparen'>(</span><span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!!! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The database column currently associated with uploaded file information
</span>  <span class='comment'># used by Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Symbol]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_data_column'>file_data_column</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='symbol'>:edit_file_data</span> <span class='op'>:</span> <span class='symbol'>:file_data</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The uploaded file currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file'>active_file</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>:</span> <span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># The file attacher currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::Attacher]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span> <span class='op'>:</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span>
  <span class='kw'>end</span>

  <span class='comment'># The file metadata currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file_data'>active_file_data</span>
    <span class='kw'>self</span><span class='lbracket'>[</span><span class='id identifier rubyid_file_data_column'>file_data_column</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Validations
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Indicate whether the attached file is valid.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attached_file_valid?'>attached_file_valid?</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_file'>active_file</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_validate'>validate</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span>
      <span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='symbol'>:file</span><span class='comma'>,</span> <span class='symbol'>:invalid</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Callbacks
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Make a debug output note to mark when a callback has occurred.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Symbol] type
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='comment'># == Usage Notes
</span>  <span class='comment'>#
</span>  <span class='comment'># :before_save # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_before_save
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#save
</span>  <span class='comment'>#
</span>  <span class='comment'># :after_commit, on: %i[create update] # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_after_save
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#finalize
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#destroy_previous
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#promote_cached
</span>  <span class='comment'>#       Shrine::Attacher::InstanceMethods#promote
</span>  <span class='comment'>#   Shrine::Plugins::Activerecord::AttacherMethods#activerecord_persist
</span>  <span class='comment'>#     ActiveRecord::Persistence#save
</span>  <span class='comment'>#
</span>  <span class='comment'># :after_commit, on: %i[destroy] # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_after_destroy
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#destroy_attached
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#destroy
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_note_cb'>note_cb</span><span class='lparen'>(</span><span class='id identifier rubyid_type'>type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_line'>__debug_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*** UPLOAD CALLBACK </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_content'> ***</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Finalize a file upload by promoting the :cache file to a :store file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *true*, don&#39;t re-raise exceptions.
</span>  <span class='comment'># @param [Boolean] keep_cached      If *true*, don&#39;t delete the original.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_promote_cached_file'>promote_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>keep_cached:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_old_file'>old_file</span>   <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_keep_cached'>keep_cached</span>
    <span class='id identifier rubyid_old_file'>old_file</span> <span class='op'>&amp;&amp;=</span> <span class='id identifier rubyid_active_file'>active_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_data'>data</span>
    <span class='id identifier rubyid_old_file'>old_file</span> <span class='op'>&amp;&amp;=</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>UploadedFile</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_old_file'>old_file</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_promote'>promote</span>
    <span class='id identifier rubyid_old_file'>old_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_delete'>delete</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># Finalize a deletion by the removing the file from :cache and/or :store.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *true*, don&#39;t re-raise exceptions.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_delete_cached_file'>delete_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Callbacks
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='comment'># Add a log message for an exception.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Exception] excp
</span>  <span class='comment'># @param [Symbol]    meth           Calling method.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_excp'>excp</span><span class='comma'>,</span> <span class='id identifier rubyid_meth'>meth</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_error'>error</span> <span class='op'>=</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_excp'>excp</span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>FileNotFound</span>      <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>FILE_NOT_FOUND</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>InvalidFile</span>       <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>INVALID_FILE</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>AttachmentChanged</span> <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ATTACHMENT_CHANGED</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>Error</span>             <span class='kw'>then</span> <span class='id identifier rubyid_error'>error</span>   <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unexpected Shrine error</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>else</span>                                <span class='id identifier rubyid_error'>error</span>   <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_excp'>excp</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> unexpected</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span> <span class='op'>?</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='op'>::</span><span class='const'>ERROR</span> <span class='op'>:</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='op'>::</span><span class='const'>WARN</span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_meth'>meth</span> <span class='op'>||</span> <span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_excp'>excp</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> [</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span> <span class='op'>||</span> <span class='id identifier rubyid_warning'>warning</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="file_attacher-instance_method">
  
    #<strong>file_attacher</strong>  &#x21d2; <tt>FileUploader::Attacher</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Saves information about the uploaded file as an attachment to a record (saving the file data to the :file_data database column).</p>

<p>The attaching process requires a temporary and a permanent storage to be registered (by default that&#39;s :cache and :store).</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::Attacher</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 27</span>

<span class='kw'>module</span> <span class='const'><span class='object_link'><a href="../Upload.html" title="Upload (class)">Upload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Upload::FileMethods (module)">FileMethods</a></span></span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../Upload.html" title="Upload (class)">Upload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WorkflowMethods.html" title="Upload::WorkflowMethods (module)">WorkflowMethods</a></span></span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileNaming.html" title="FileNaming (module)">FileNaming</a></span></span>

  <span class='comment'># Non-functional hints for RubyMine type checking.
</span>  <span class='comment'># :nocov:
</span>  <span class='kw'>unless</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#ONLY_FOR_DOCUMENTATION-constant" title="ONLY_FOR_DOCUMENTATION (constant)">ONLY_FOR_DOCUMENTATION</a></span></span>

    <span class='comment'># Represents a file that was uploaded to a storage.
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::UploadedFile]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see Shrine::ClassMethods#inherited (Created via Shrine)
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:file</span>

    <span class='comment'># Saves information about the uploaded file as an attachment to a record
</span>    <span class='comment'># (saving the file data to the :file_data database column).
</span>    <span class='comment'>#
</span>    <span class='comment'># The attaching process requires a temporary and a permanent storage to be
</span>    <span class='comment'># registered (by default that&#39;s :cache and :store).
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::Attacher]
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:file_attacher</span>

    <span class='comment'># Represents a file that was uploaded to a storage as a replacement for the
</span>    <span class='comment'># originally-submitted file.
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::UploadedFile]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see #file
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:edit_file</span>

    <span class='comment'># Saves information about the uploaded replacement as an attachment to a
</span>    <span class='comment'># record (saving the file data to the :edit_file_data database column).
</span>    <span class='comment'>#
</span>    <span class='comment'># The attaching process requires a temporary and a permanent storage to be
</span>    <span class='comment'># registered (by default that&#39;s :cache and :store).
</span>    <span class='comment'>#
</span>    <span class='comment'># @return [FileUploader::Attacher]
</span>    <span class='comment'>#
</span>    <span class='comment'># @see #file_attacher
</span>    <span class='comment'>#
</span>    <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:edit_file_attacher</span>

  <span class='kw'>end</span>
  <span class='comment'># :nocov:
</span>
  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The maximum age (in seconds) allowed for download links which are meant to
</span>  <span class='comment'># be valid only for a single time.
</span>  <span class='comment'>#
</span>  <span class='comment'># This should be generous to allow for network delays.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Integer]
</span>  <span class='comment'>#
</span>  <span class='const'><span class='object_link'><a href="#ONE_TIME_USE_EXPIRATION-constant" title="Upload::FileMethods::ONE_TIME_USE_EXPIRATION (constant)">ONE_TIME_USE_EXPIRATION</a></span></span> <span class='op'>=</span> <span class='int'>10</span>

  <span class='comment'># The maximum age (in seconds) allowed for download links.
</span>  <span class='comment'>#
</span>  <span class='comment'># This allows the link to be reused for a while, but not long enough to allow
</span>  <span class='comment'># sharing of content URLs for distribution.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Integer]
</span>  <span class='comment'>#
</span>  <span class='const'><span class='object_link'><a href="#DOWNLOAD_EXPIRATION-constant" title="Upload::FileMethods::DOWNLOAD_EXPIRATION (constant)">DOWNLOAD_EXPIRATION</a></span></span> <span class='op'>=</span> <span class='int'>1800</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Fields
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Shrine attachment for :file_data.
</span>  <span class='comment'>#
</span>  <span class='comment'># noinspection RubyResolve
</span>  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>Attachment</span><span class='lparen'>(</span><span class='symbol'>:file</span><span class='rparen'>)</span>

  <span class='comment'># Shrine attachment for :edit_file_data, which is applicable only when
</span>  <span class='comment'># `#phase` is &quot;edit&quot;.
</span>  <span class='comment'>#
</span>  <span class='comment'># noinspection RubyResolve
</span>  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>Attachment</span><span class='lparen'>(</span><span class='symbol'>:edit_file</span><span class='rparen'>)</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Full name of the file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_filename'>filename</span>
    <span class='ivar'>@filename</span> <span class='op'>||=</span> <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file, loading it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
    <span class='id identifier rubyid_file'>file</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file_data'>file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_data'>file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Full name of the file when editing an existing entry.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span>
    <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file, loading it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
    <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>||</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Full name of the file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_filename'>active_filename</span>
    <span class='comment'># noinspection RubyYardReturnMatch
</span>    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span> <span class='op'>||</span> <span class='id identifier rubyid_filename'>filename</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the attached file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span> <span class='op'>||</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Return the cached file, attaching it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attach_cached'>attach_cached</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_stored?'>stored?</span> <span class='op'>||</span> <span class='id identifier rubyid_file_data'>file_data</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file_data'>file_data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the cached file, attaching it if necessary (and possible).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_edit_attach_cached'>edit_attach_cached</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_stored?'>stored?</span> <span class='op'>||</span> <span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_cached?'>cached?</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># Return the cached file currently associated with the record.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_attach_cached'>edit_attach_cached</span> <span class='op'>:</span> <span class='id identifier rubyid_attach_cached'>attach_cached</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Move the uploaded file to its final destination.
</span>  <span class='comment'>#
</span>  <span class='comment'># If the file is in :cache it will be moved to :store.  If it&#39;s already in
</span>  <span class='comment'># :store then this is a no-op.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *false*, re-raise exceptions.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_promote_file'>promote_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_promote_cached_file'>promote_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='id identifier rubyid_no_raise'>no_raise</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Remove the uploaded file from storage (either :store or :cache).
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *false*, re-raise exceptions.
</span>  <span class='comment'># @param [Symbol] field             Either :file_data or :edit_file_data;
</span>  <span class='comment'>#                                     otherwise the field is determined by
</span>  <span class='comment'>#                                     the phase.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_delete_file'>delete_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>field:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_destroyed?'>destroyed?</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_field'>field</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
      <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:edit_file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
      <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Generate a URL to the uploaded file which can be used to download the file
</span>  <span class='comment'># to the client browser.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Hash] opt                 Passed to Shrine::UploadedFile#url.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String]
</span>  <span class='comment'># @return [nil]                     If :file_data is blank.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_download_url'>download_url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:expires_in</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'><span class='object_link'><a href="#ONE_TIME_USE_EXPIRATION-constant" title="Upload::FileMethods::ONE_TIME_USE_EXPIRATION (constant)">ONE_TIME_USE_EXPIRATION</a></span></span>
    <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_url'>url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># The AWS S3 object for the file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Aws::S3::Object, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_s3_object'>s3_object</span>
    <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_storage'>storage</span><span class='op'>&amp;.</span><span class='id identifier rubyid_object'>object</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># Acquire a file and upload it to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] file_path
</span>  <span class='comment'># @param [Hash]   opt               Passed to FileUploader::Attacher#attach
</span>  <span class='comment'>#                                     except for:
</span>  <span class='comment'>#
</span>  <span class='comment'># @option [Symbol] :meth            Calling method (for logging).
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='comment'># == Usage Notes
</span>  <span class='comment'># This method is not necessary for an Upload instance which is persisted to
</span>  <span class='comment'># the database because Shrine adds event handlers which cause the file to be
</span>  <span class='comment'># copied to storage.  This method is allows this action for a &quot;free-standing&quot;
</span>  <span class='comment'># Upload instance (without needing to execute #save in order to engage Shrine
</span>  <span class='comment'># event handlers to copy the file to storage).
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_fetch_and_upload_file'>fetch_and_upload_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_meth'>meth</span>   <span class='op'>=</span> <span class='id identifier rubyid_opt'>opt</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:meth</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid___method__'>__method__</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_file_path'>file_path</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^https?:</span><span class='regexp_end'>/</span></span>
        <span class='id identifier rubyid_upload_remote_file'>upload_remote_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_upload_local_file'>upload_local_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>
      <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_size'>size</span>      <span class='op'>||</span> <span class='int'>0</span>
      <span class='id identifier rubyid_type'>type</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_mime_type'>mime_type</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unknown MIME type</span><span class='tstring_end'>&#39;</span></span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_meth'>meth</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_size'>size</span><span class='embexpr_end'>}</span><span class='tstring_content'> bytes) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_result'>result</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Options for Down#open.
</span>  <span class='comment'>#
</span>  <span class='comment'># @type [Hash]
</span>  <span class='comment'>#
</span>  <span class='comment'># @see Down::NetHttp#initialize
</span>  <span class='comment'># @see Down::NetHttp#open
</span>  <span class='comment'># @see Down::NetHttp#create_net_http
</span>  <span class='comment'>#
</span>  <span class='const'>DOWN_OPEN_OPTIONS</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='label'>read_timeout:</span> <span class='int'>60</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_deep_freeze'>deep_freeze</span>

  <span class='comment'># Acquire a remote file and copy it to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url
</span>  <span class='comment'># @param [Hash]   opt     Passed to FileUploader::Attacher#attach except for:
</span>  <span class='comment'>#
</span>  <span class='comment'># @option opt [Integer] :read_retry
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_upload_remote_file'>upload_remote_file</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='comment'># @type [Down::ChunkedIO] io
</span>    <span class='id identifier rubyid_io'>io</span> <span class='op'>=</span> <span class='const'>Down</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='op'>**</span><span class='const'>DOWN_OPEN_OPTIONS</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:metadata</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>filename</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_attach'>attach</span><span class='lparen'>(</span><span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!!! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span>
  <span class='kw'>ensure</span>
    <span class='comment'># noinspection RubyScope
</span>    <span class='id identifier rubyid_io'>io</span><span class='op'>&amp;.</span><span class='id identifier rubyid_close'>close</span>
  <span class='kw'>end</span>

  <span class='comment'># Copy a local file to storage.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] path
</span>  <span class='comment'># @param [Hash]   opt               Passed to FileUploader::Attacher#attach
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_upload_local_file'>upload_local_file</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_io'>io</span><span class='op'>|</span>
      <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_attach'>attach</span><span class='lparen'>(</span><span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!!! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The database column currently associated with uploaded file information
</span>  <span class='comment'># used by Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Symbol]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_data_column'>file_data_column</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='symbol'>:edit_file_data</span> <span class='op'>:</span> <span class='symbol'>:file_data</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section:
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_public'>public</span>

  <span class='comment'># The uploaded file currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::UploadedFile, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file'>active_file</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>:</span> <span class='id identifier rubyid_file'>file</span>
  <span class='kw'>end</span>

  <span class='comment'># The file attacher currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [FileUploader::Attacher]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span>
    <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span> <span class='op'>:</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span>
  <span class='kw'>end</span>

  <span class='comment'># The file metadata currently being used with Shrine.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [String, nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_active_file_data'>active_file_data</span>
    <span class='kw'>self</span><span class='lbracket'>[</span><span class='id identifier rubyid_file_data_column'>file_data_column</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Validations
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Indicate whether the attached file is valid.
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_attached_file_valid?'>attached_file_valid?</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_file'>active_file</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_validate'>validate</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span>
      <span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='symbol'>:file</span><span class='comma'>,</span> <span class='symbol'>:invalid</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Callbacks
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_protected'>protected</span>

  <span class='comment'># Make a debug output note to mark when a callback has occurred.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Symbol] type
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='comment'># == Usage Notes
</span>  <span class='comment'>#
</span>  <span class='comment'># :before_save # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_before_save
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#save
</span>  <span class='comment'>#
</span>  <span class='comment'># :after_commit, on: %i[create update] # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_after_save
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#finalize
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#destroy_previous
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#promote_cached
</span>  <span class='comment'>#       Shrine::Attacher::InstanceMethods#promote
</span>  <span class='comment'>#   Shrine::Plugins::Activerecord::AttacherMethods#activerecord_persist
</span>  <span class='comment'>#     ActiveRecord::Persistence#save
</span>  <span class='comment'>#
</span>  <span class='comment'># :after_commit, on: %i[destroy] # should trigger:
</span>  <span class='comment'># Shrine::Plugins::Activerecord::AttacherMethods#activerecord_after_destroy
</span>  <span class='comment'>#   Shrine::Attacher::InstanceMethods#destroy_attached
</span>  <span class='comment'>#     Shrine::Attacher::InstanceMethods#destroy
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_note_cb'>note_cb</span><span class='lparen'>(</span><span class='id identifier rubyid_type'>type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_line'>__debug_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*** UPLOAD CALLBACK </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_content'> ***</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Finalize a file upload by promoting the :cache file to a :store file.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *true*, don&#39;t re-raise exceptions.
</span>  <span class='comment'># @param [Boolean] keep_cached      If *true*, don&#39;t delete the original.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_promote_cached_file'>promote_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>keep_cached:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_old_file'>old_file</span>   <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_keep_cached'>keep_cached</span>
    <span class='id identifier rubyid_old_file'>old_file</span> <span class='op'>&amp;&amp;=</span> <span class='id identifier rubyid_active_file'>active_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_data'>data</span>
    <span class='id identifier rubyid_old_file'>old_file</span> <span class='op'>&amp;&amp;=</span> <span class='const'><span class='object_link'><a href="../FileUploader.html" title="FileUploader (class)">FileUploader</a></span></span><span class='op'>::</span><span class='const'>UploadedFile</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_old_file'>old_file</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_promote'>promote</span>
    <span class='id identifier rubyid_old_file'>old_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_delete'>delete</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># Finalize a deletion by the removing the file from :cache and/or :store.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Boolean] no_raise         If *true*, don&#39;t re-raise exceptions.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [void]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_delete_cached_file'>delete_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_active_attach_cached'>active_attach_cached</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
  <span class='kw'>end</span>

  <span class='comment'># ===========================================================================
</span>  <span class='comment'># :section: Callbacks
</span>  <span class='comment'># ===========================================================================
</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='comment'># Add a log message for an exception.
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Exception] excp
</span>  <span class='comment'># @param [Symbol]    meth           Calling method.
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [nil]
</span>  <span class='comment'>#
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_excp'>excp</span><span class='comma'>,</span> <span class='id identifier rubyid_meth'>meth</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_error'>error</span> <span class='op'>=</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_excp'>excp</span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>FileNotFound</span>      <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>FILE_NOT_FOUND</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>InvalidFile</span>       <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>INVALID_FILE</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>AttachmentChanged</span> <span class='kw'>then</span> <span class='id identifier rubyid_warning'>warning</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ATTACHMENT_CHANGED</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>when</span> <span class='const'>Shrine</span><span class='op'>::</span><span class='const'>Error</span>             <span class='kw'>then</span> <span class='id identifier rubyid_error'>error</span>   <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unexpected Shrine error</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>else</span>                                <span class='id identifier rubyid_error'>error</span>   <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_excp'>excp</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> unexpected</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span> <span class='op'>?</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='op'>::</span><span class='const'>ERROR</span> <span class='op'>:</span> <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='op'>::</span><span class='const'>WARN</span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_meth'>meth</span> <span class='op'>||</span> <span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_excp'>excp</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> [</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span> <span class='op'>||</span> <span class='id identifier rubyid_warning'>warning</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="active_attached_file-instance_method">
  
    #<strong>active_attached_file</strong>  &#x21d2; <tt>FileUploader::UploadedFile</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return the attached file currently associated with the record.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::UploadedFile</tt>)</span>
      
      
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If :file_data is blank.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


177
178
179</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 177</span>

<span class='kw'>def</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
  <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span> <span class='op'>||</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="active_file-instance_method">
  
    #<strong>active_file</strong>  &#x21d2; <tt>FileUploader::UploadedFile</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The uploaded file currently being used with Shrine.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::UploadedFile</tt>, <tt>nil</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


416
417
418</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 416</span>

<span class='kw'>def</span> <span class='id identifier rubyid_active_file'>active_file</span>
  <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>:</span> <span class='id identifier rubyid_file'>file</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="active_file_attacher-instance_method">
  
    #<strong>active_file_attacher</strong>  &#x21d2; <tt>FileUploader::Attacher</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The file attacher currently being used with Shrine.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::Attacher</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


424
425
426</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 424</span>

<span class='kw'>def</span> <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span>
  <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span> <span class='op'>:</span> <span class='id identifier rubyid_file_attacher'>file_attacher</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="active_file_data-instance_method">
  
    #<strong>active_file_data</strong>  &#x21d2; <tt>String</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The file metadata currently being used with Shrine.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


432
433
434</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 432</span>

<span class='kw'>def</span> <span class='id identifier rubyid_active_file_data'>active_file_data</span>
  <span class='kw'>self</span><span class='lbracket'>[</span><span class='id identifier rubyid_file_data_column'>file_data_column</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="active_filename-instance_method">
  
    #<strong>active_filename</strong>  &#x21d2; <tt>String</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Full name of the file currently associated with the record.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If :file_data is blank.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


167
168
169
170</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 167</span>

<span class='kw'>def</span> <span class='id identifier rubyid_active_filename'>active_filename</span>
  <span class='comment'># noinspection RubyYardReturnMatch
</span>  <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span> <span class='op'>||</span> <span class='id identifier rubyid_filename'>filename</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="attached_file-instance_method">
  
    #<strong>attached_file</strong>  &#x21d2; <tt>FileUploader::UploadedFile</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return the attached file, loading it if necessary (and possible).</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::UploadedFile</tt>)</span>
      
      
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If :file_data is blank.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


139
140
141</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 139</span>

<span class='kw'>def</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
  <span class='id identifier rubyid_file'>file</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_file_data'>file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_file_data'>file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="delete_file-instance_method">
  
    #<strong>delete_file</strong>(no_raise: true, field: nil)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Remove the uploaded file from storage (either :store or :cache).</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>no_raise</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../top-level-namespace.html#Boolean-constant" title="Boolean (constant)">Boolean</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>If <strong>false</strong>, re-raise exceptions.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>field</span>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Either :file_data or :edit_file_data; otherwise the field is determined by the phase.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 251</span>

<span class='kw'>def</span> <span class='id identifier rubyid_delete_file'>delete_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>field:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_destroyed?'>destroyed?</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_field'>field</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_active_attached_file'>active_attached_file</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_active_file_attacher'>active_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:edit_file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span> <span class='op'>==</span> <span class='symbol'>:file_data</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_attached_file'>attached_file</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
    <span class='id identifier rubyid_file_attacher'>file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
  <span class='id identifier rubyid_log_exception'>log_exception</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span> <span class='kw'>unless</span> <span class='id identifier rubyid_no_raise'>no_raise</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="download_url-instance_method">
  
    #<strong>download_url</strong>(**opt)  &#x21d2; <tt>String</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generate a URL to the uploaded file which can be used to download the file to the client browser.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>opt</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Passed to Shrine::UploadedFile#url.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If :file_data is blank.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


283
284
285
286</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 283</span>

<span class='kw'>def</span> <span class='id identifier rubyid_download_url'>download_url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:expires_in</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'><span class='object_link'><a href="#ONE_TIME_USE_EXPIRATION-constant" title="Upload::FileMethods::ONE_TIME_USE_EXPIRATION (constant)">ONE_TIME_USE_EXPIRATION</a></span></span>
  <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_url'>url</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="edit_attached_file-instance_method">
  
    #<strong>edit_attached_file</strong>  &#x21d2; <tt>FileUploader::UploadedFile</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return the attached file, loading it if necessary (and possible).</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::UploadedFile</tt>)</span>
      
      
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If :file_data is blank.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


157
158
159
160</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 157</span>

<span class='kw'>def</span> <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span>
  <span class='id identifier rubyid_edit_file'>edit_file</span> <span class='op'>||</span>
    <span class='lparen'>(</span><span class='id identifier rubyid_edit_file_attacher'>edit_file_attacher</span><span class='period'>.</span><span class='id identifier rubyid_load_data'>load_data</span><span class='lparen'>(</span><span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_edit_file_data'>edit_file_data</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="edit_filename-instance_method">
  
    #<strong>edit_filename</strong>  &#x21d2; <tt>String</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Full name of the file when editing an existing entry.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If :file_data is blank.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


148
149
150</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 148</span>

<span class='kw'>def</span> <span class='id identifier rubyid_edit_filename'>edit_filename</span>
  <span class='id identifier rubyid_edit_attached_file'>edit_attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="fetch_and_upload_file-instance_method">
  
    #<strong>fetch_and_upload_file</strong>(file_path, **opt)  &#x21d2; <tt>FileUploader::UploadedFile</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Acquire a file and upload it to storage.</p>

<h2 id="label-Usage+Notes">Usage Notes</h2>

<p>This method is not necessary for an Upload instance which is persisted to the database because Shrine adds event handlers which cause the file to be copied to storage.  This method is allows this action for a “free-standing” Upload instance (without needing to execute #save in order to engage Shrine event handlers to copy the file to storage).</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>file_path</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
    <li>
      
        <span class='name'>opt</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Passed to FileUploader::Attacher#attach except for:</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>[Symbol]</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>a customizable set of options</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>FileUploader::UploadedFile</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 319</span>

<span class='kw'>def</span> <span class='id identifier rubyid_fetch_and_upload_file'>fetch_and_upload_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_meth'>meth</span>   <span class='op'>=</span> <span class='id identifier rubyid_opt'>opt</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:meth</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid___method__'>__method__</span>
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_file_path'>file_path</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^https?:</span><span class='regexp_end'>/</span></span>
      <span class='id identifier rubyid_upload_remote_file'>upload_remote_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_upload_local_file'>upload_local_file</span><span class='lparen'>(</span><span class='id identifier rubyid_file_path'>file_path</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='const'><span class='object_link'><a href="../top-level-namespace.html#Log-constant" title="Log (constant)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>
    <span class='id identifier rubyid_size'>size</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_size'>size</span>      <span class='op'>||</span> <span class='int'>0</span>
    <span class='id identifier rubyid_type'>type</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='op'>&amp;.</span><span class='id identifier rubyid_mime_type'>mime_type</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unknown MIME type</span><span class='tstring_end'>&#39;</span></span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_meth'>meth</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_size'>size</span><span class='embexpr_end'>}</span><span class='tstring_content'> bytes) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="file_data_column-instance_method">
  
    #<strong>file_data_column</strong>  &#x21d2; <tt>Symbol</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The database column currently associated with uploaded file information used by Shrine.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 402</span>

<span class='kw'>def</span> <span class='id identifier rubyid_file_data_column'>file_data_column</span>
  <span class='id identifier rubyid_edit_phase'>edit_phase</span> <span class='op'>?</span> <span class='symbol'>:edit_file_data</span> <span class='op'>:</span> <span class='symbol'>:file_data</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="filename-instance_method">
  
    #<strong>filename</strong>  &#x21d2; <tt>String</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Full name of the file.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If :file_data is blank.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


130
131
132</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 130</span>

<span class='kw'>def</span> <span class='id identifier rubyid_filename'>filename</span>
  <span class='ivar'>@filename</span> <span class='op'>||=</span> <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_original_filename'>original_filename</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dup'>dup</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="promote_file-instance_method">
  
    #<strong>promote_file</strong>(no_raise: true)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Move the uploaded file to its final destination.</p>

<p>If the file is in :cache it will be moved to :store.  If it&#39;s already in :store then this is a no-op.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>no_raise</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../top-level-namespace.html#Boolean-constant" title="Boolean (constant)">Boolean</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>If <strong>false</strong>, re-raise exceptions.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


237
238
239
240</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 237</span>

<span class='kw'>def</span> <span class='id identifier rubyid_promote_file'>promote_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='id identifier rubyid___debug_items'>__debug_items</span><span class='lparen'>(</span><span class='id identifier rubyid_binding'>binding</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_promote_cached_file'>promote_cached_file</span><span class='lparen'>(</span><span class='label'>no_raise:</span> <span class='id identifier rubyid_no_raise'>no_raise</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="s3_object-instance_method">
  
    #<strong>s3_object</strong>  &#x21d2; <tt>Aws::S3::Object</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The AWS S3 object for the file.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Aws::S3::Object</tt>, <tt>nil</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


292
293
294</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/upload/file_methods.rb', line 292</span>

<span class='kw'>def</span> <span class='id identifier rubyid_s3_object'>s3_object</span>
  <span class='id identifier rubyid_attached_file'>attached_file</span><span class='op'>&amp;.</span><span class='id identifier rubyid_storage'>storage</span><span class='op'>&amp;.</span><span class='id identifier rubyid_object'>object</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Sat Feb  6 16:05:42 2021 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-2.7.2).
</div>

    </div>
  </body>
</html>